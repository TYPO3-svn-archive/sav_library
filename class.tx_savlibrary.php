<?php/****************************************************************  Copyright notice**  (c) 2008 Yolf (yolf.typo3@orange.fr)*  All rights reserved**  This script is part of the TYPO3 project. The TYPO3 project is*  free software; you can redistribute it and/or modify*  it under the terms of the GNU General Public License as published by*  the Free Software Foundation; either version 2 of the License, or*  (at your option) any later version.**  The GNU General Public License can be found at*  http://www.gnu.org/copyleft/gpl.html.**  This script is distributed in the hope that it will be useful,*  but WITHOUT ANY WARRANTY; without even the implied warranty of*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the*  GNU General Public License for more details.**  This copyright notice MUST APPEAR in all copies of the script!***************************************************************//** * SAV Library: Common code for SAV extensions * * @author	Yolf <yolf.typo3@orange.fr> * */require_once(PATH_t3lib.'class.t3lib_tsparser.php');require_once ('dateselectlib/class.tx_savdateselectlib.php');require_once ('class.tx_savlibrary_defaultVerifiers.php');require_once ('class.tx_savlibrary_defaultQueriers.php');require_once ('class.tx_savlibrary_defaultItemviewers.php');require_once ('class.tx_savlibrary_defaultViewers.php');// Debug constantsdefine ('DEBUG_NONE', 0);define ('DEBUG_QUERY', 1);class tx_savlibrary {  	public $extObj;                        // Reference to the extension object	public $viewers;                       // viewers object	public $queriers;                      // queriers object	public $itemviewers;                   // itemsviewers object	public $verifiers;                     // verifiers object		public $debug = DEBUG_NONE;            // Debug variable. Use debug ONLY for development.		protected $templateCode;               // Template code for savlibrary views	public $conf;                          // Configuration variables  public $formShortName;                 // Name of the form without the cObj id  public $formName;                      // Name of the form  public $errorInForm = false;           // If true, a field error occured in the input form  protected $messages = array();         // Messages  protected $errors = array();           // Error messages    // Session variables  public $sessionExt = array();          // Extensions data  public $sessionFilter = array();       // Filters data  public $sessionFilterSelected ='';     // Selected filter key    // Variables for HTML outputs    	  public $EOL = '';                      // End of line for HTML output  public $TAB = '';                      // Tabulation  public $SPACE = '';                    // Space before element  public $WRAP = '';                     // String before wrapping    	public $formAction = '';               // Action to be performed  public $limit = 0;                     // Used with arrow button  public $limitSub = array();            // Limit for the sub form  public $page = '';                     // label of the page folder if any  public $uid = 0;        	             // uid of the current record	public $inputMode = 0;                 // Set if in inputMode  public $deleteConfirmed = 0;           // Set if delete is confirmed  public $isNewForm = false;             // Set if new form or sub form values were posted		public $formConfig;                    // configuration of the form	public $viewName;                      // Name of the current view		public $savlibraryConfig = array();    // Configuration of the savlibrary extension  (item viewers, viewers, data handlers)  public $rowItem;                       // Used in subForm views  public $rowItemFromButton;             // Used in subForm views to get the subitem uid from a button   public $fieldFromButton;               // Used in subForm views to get the field associated with a button  public $newSubForm = 0;                // New button has been activated in SubForm  public $subFormName = '';              // Field name associated with the subform  protected $fusion = 0;                 // For the fusion of cells  protected $fusionBegin = 0;            // For the fusion of cells  protected $fusionEnd = 0;              // For the fusion of cells  public $selectList = '';               // List of onclick actions for select multiple items  public $titleProcessed = false;        // Flag to process the form title only once    public $tableLocal = '';       // Local table name    // Directories  protected $iconsDir;           // icons directory  /**   * Constructor   *    * @retrun none   */  public function __construct() {    $this->EOL = chr(10);     $this->TAB = chr(9);     $this->SPACE = '          ';    $this->WRAP = $this->EOL.$this->TAB.$this->TAB;      }                      	/***************************************************************/	/* configuration methods                                       */	/***************************************************************/	/**	 * Initialization	 *	 * @param $conf array (configuration)	 * @param $flexform boolean (if true the configuration is obtained from the flexform)   *	 * @return boolean (true if no error occurs)	 */  protected function init($conf, $flexform = 1) {    // Check if a global maintenance is requested    $temp = unserialize($GLOBALS['TYPO3_CONF_VARS']['EXT']['extConf']['sav_library']);    $maintenanceAllowedUsers = explode(',', $temp['maintenanceAllowedUsers']);    if ($temp['maintenance']) {      $this->addError('error.underMaintenance');      if (!in_array($GLOBALS['TSFE']->fe_user->user['uid'], $maintenanceAllowedUsers)) {        return false;               }    }    // Check if a maintenance of the extension is requested    $temp = unserialize($GLOBALS['TYPO3_CONF_VARS']['EXT']['extConf'][$this->extObj->extKey]);        if ($temp['maintenance']) {      $this->addError('error.underMaintenance');      if (!in_array($GLOBALS['TSFE']->fe_user->user['uid'], $maintenanceAllowedUsers)) {        return false;               }    }    // Set debug    if ($this->debug & DEBUG_QUERY) {      $GLOBALS['TYPO3_DB']->debugOutput=true;    }        // Instanciate the classes abd set the reference to savlibrary    $this->viewers = t3lib_div::makeInstance('tx_savlibrary_defaultViewers');    $this->viewers->savlibrary = &$this;        $this->queriers = t3lib_div::makeInstance('tx_savlibrary_defaultQueriers');    $this->queriers->savlibrary = &$this;        $this->itemviewers = t3lib_div::makeInstance('tx_savlibrary_defaultItemviewers');    $this->itemviewers->savlibrary = &$this;    $this->verifiers = t3lib_div::makeInstance('tx_savlibrary_defaultVerifiers');    $this->verifiers->savlibrary = &$this;    // Check the compatibility between the extension version and the library version.     // Versions are under the format x.y.z. Compatibility is satisfied if x's are the same    preg_match('/^([0-9])\./', $GLOBALS['TYPO3_CONF_VARS']['EXTCONF']['sav_library']['version'], $versionLibrary);    preg_match('/^([0-9])\./', $this->extObj->extConfig['version'], $versionExt);    if ($versionLibrary[1] != $versionExt[1]) {      $this->addError('error.incorrectVersion');      return false;    }			// Set the configuration		$this->conf = $conf; 	    // Init FlexForm configuration for plugin and get the configuration fields		    if ($flexform) {      $this->extObj->pi_initPIflexForm();       if (!isset($this->extObj->cObj->data['pi_flexform']['data'])) {        $this->addError('error.incorrectPluginConfiguration_1', $this->extObj->extKey);        $this->addError('error.incorrectPluginConfiguration_2');        return false;      }      foreach ($this->extObj->cObj->data['pi_flexform']['data'] as $sheet => $data) {        foreach ($this->extObj->cObj->data['pi_flexform']['data'][$sheet]['lDEF'] as $key => $value) {  		    $this->conf[$key] = $this->extObj->pi_getFFvalue($this->extObj->cObj->data['pi_flexform'], $key, $sheet);        }      }      // Set the form ID      $formId = $this->conf['formId'];      if (!$formId) {        $this->addError('error.noFormSelectedInFlexform', $this->extObj->extKey);        return false;      }                  // Add the content id as a fragment to links      $this->extObj->pi_moreParams = ($this->conf['addFragment'] ? '#c' . $this->extObj->cObj->data['uid'] : '');          } else {      $formId = 1;    }		$this->formConfig = array(		  'title' => $this->extObj->extConfig['forms'][$formId]['title'],      'showAll' => $this->extObj->extConfig['forms'][$formId]['showAllView'],      'showSingle' => $this->extObj->extConfig['forms'][$formId]['showSingleView'],      'inputForm' => $this->extObj->extConfig['forms'][$formId]['inputView'],      'updateForm' => $this->extObj->extConfig['forms'][$formId]['updateView'],      'altForm' => $this->extObj->extConfig['forms'][$formId]['altView'],      'query' => $this->extObj->extConfig['forms'][$formId]['query'],    );    $this->formShortName = $this->extObj->extKey.'_'.str_replace(' ', '_', strtolower($this->extObj->extConfig['forms'][$formId]['title']));	    $this->formName = $this->formShortName.'_'.$this->extObj->cObj->data['uid'];	    // Set the local table name    $this->tableLocal = $this->extObj->extConfig['queries'][$this->formConfig['query']]['tableLocal'];		  		// Add the select List JavaScript to page header if a user is logged (intranet)		$this->path = t3lib_extMgm::siteRelPath('sav_library');				if (isset($GLOBALS['TSFE']->fe_user->user) && !$GLOBALS['TSFE']->additionalHeaderData['tx_savlibrary']) {	      $GLOBALS['TSFE']->additionalHeaderData['tx_savlibrary'] = $this->TAB.'<script type="text/javascript" src="'.t3lib_extMgm::siteRelPath('sav_library').'res/sav_library.js"></script>';					}  		// For a nice input of the date		if ($conf['dateSelectCss']) {			tx_savdateselectlib::includeLib($conf['dateSelectCss']);		} else {			tx_savdateselectlib::includeLib();		}      // Include the css file for the extension, if any      // The css file should be extension.css in the extension/res directory, where "extension" is the extension key		if (file_exists(t3lib_extMgm::extPath($this->extObj->extKey).'res/'.$this->extObj->extKey.'.css')) {      $GLOBALS['TSFE']->additionalHeaderData['tx_savlibrary'] = $this->TAB . '<link rel="stylesheet" type="text/css" href="' . t3lib_extMgm::siteRelPath($this->extObj->extKey) . 'res/' . $this->extObj->extKey . '.css' . '" />';    }		  // Set the icon directory.       // The icon directory is taken from the configuration in TS if set,      // else from the res/icons folder in the extension if it exists,       // else from the default res/icons in the sav_library.		if ($this->conf['iconsDir']) {      $this->iconsDir = $this->conf['iconsDir'];    } elseif (file_exists(t3lib_extMgm::siteRelPath($this->extObj->extKey) . 'res/icons')) {      $this->iconsDir = t3lib_extMgm::siteRelPath($this->extObj->extKey) . 'res/icons/';    } else {		  $this->iconsDir = t3lib_extMgm::siteRelPath('sav_library') . 'res/icons/';		}		  		// Read the template file.   		// The template file is defined by the configuration in TS if set,      // else it is the file extension.tmpl in the extension/res directory, where "extension" is the extension key, if it exits.  		// else it is the default file sav_library.tmpl in the sav_library/res directory.  	if ($this->conf['template'] && file_exists(PATH_site.$this->conf['template'])) {			$this->templateCode = $this->extObj->cObj->fileResource($this->conf['template']);       } elseif (file_exists(t3lib_extMgm::extPath($this->extObj->extKey) . 'res/' . $this->extObj->extKey . '.tmpl')) {			$this->templateCode = $this->extObj->cObj->fileResource('EXT:' . $this->extObj->extKey . '/res/' . $this->extObj->extKey . '.tmpl');		} elseif (file_exists(t3lib_extMgm::extPath('sav_library') . 'res/sav_library.tmpl')) {  			$this->templateCode = $this->extObj->cObj->fileResource('EXT:sav_library/res/sav_library.tmpl');		} else {        $this->addError('error.templateNeeded');        return false;		}				  		// Read the xml configutation xml      // The configuration file is taken in the sav_library/res directory.		if (file_exists(t3lib_extMgm::extPath('sav_library') . 'res/sav_library.xml')) {  		$xml = $this->extObj->cObj->fileResource('EXT:sav_library/res/sav_library.xml');		} else {      $this->addError('error.configurationNeeded');      return false;    }    // Set the configuration of the library    $this->xmlToSavlibrayConfig($xml);      // Check if SAV Library Extends is active    if (t3lib_extMgm::isLoaded('sav_library_extends')) {      $this->initExtends();    } 		return true;	}  /**   *  Set the configuration for queriers, viewers and item viewers from xml   *     * @param $xml (xml configuration)   *    * @return none   */    protected function xmlToSavlibrayConfig($xml) {    // Convert xml into array    $temp = t3lib_div::xml2array($xml);    reset($temp);    // Set the queriers    foreach($temp['queriers'] as $key => $value) {      if (is_array($value)) {        foreach($value as $keyInArray => $valueInArray) {          if(trim($valueInArray)) {            $this->savlibraryConfig['queriers'][$key][$keyInArray] = trim($valueInArray);          }        }            } elseif (trim($value)) {        $this->savlibraryConfig['queriers'][$key] = trim($value);      }    }        // Set the viewers    foreach($temp['viewers'] as $key => $value) {      if (trim($value)) {        $this->savlibraryConfig['viewers'][$key] = trim($value);      }    }    // Set the item viewers    foreach ($temp['itemviewers'] as $name => $element) {      $x['name'] = $name;      $x['conditions'] = $element['conditions'];      $this->savlibraryConfig['itemviewers'][$element['type']][] = $x;    }          }               		/**	 * Call the form generator. This should be called in the main function of the plugin class.	 *	 * @param $conf array (configuration)	 *	 * @return string (the whole content result)	 */	public function generateForm($conf){				if (!$this->init($conf)) {      return $this->extObj->pi_wrapInBaseClass($this->showErrors());        }    // Get the session data    $this->sessionExt = $GLOBALS['TSFE']->fe_user->getKey('ses','ext');    $this->sessionFilter = $GLOBALS['TSFE']->fe_user->getKey('ses','filter');    $this->sessionFilterSelected = $GLOBALS['TSFE']->fe_user->getKey('ses','filterSelected');        // Check if the extension was active, removed by an another extension and post values are sent    if (!$this->sessionExt[$this->formName] && t3lib_div::_GP('sav_library') && is_array(t3lib_div::_POST($this->formName))) {      // Display an error message, remove posted data and set the extension in the showSingle mode      $this->addError('error.notSavedElapsedTime');      unset($_POST[$this->formName]);      unset($_GET[$this->formName]['formAction']);      $this->sessionExt[$this->formName]['formAction'] = 'showSingle';    }        // Set the page id and the time stamp      $this->sessionExt[$this->formName]['pageID'] = $GLOBALS['TSFE']->id;    $this->sessionExt[$this->formName]['tstamp'] = time();       // Remove extensions which are too old    $extValidity = ($conf['extValidity '] ? $conf['extValidity '] : 1 )*3600; // extension validity in second    reset($this->sessionExt);    foreach ($this->sessionExt as $keyExt => $valueExt) {      if (time() >  $valueExt['tstamp'] + $extValidity) {        unset($this->sessionExt[$keyExt]);      }    }    // Remove filters which are too old or which have a page id associated with no active extension    if ($this->sessionFilter) {      reset($this->sessionFilter);      foreach ($this->sessionFilter as $keyFilter => $valueFilter) {        if (time() > $valueFilter['tstamp'] + $extValidity) {          unset($this->sessionFilter[$keyFilter]);        } else {          $found = 0;          reset($this->sessionExt);          foreach ($this->sessionExt as $keyExt => $valueExt) {            if ($valueExt['pageID'] == $valueFilter['pageID']) {              $found = 1;              break;            }          }          if (!$found) {            unset($this->sessionFilter[$keyFilter]);          }        }      }    }             if (!t3lib_div::_GP('sav_library') || (t3lib_div::_GP('sav_library') && $this->sessionFilter[$this->sessionFilterSelected]['formAction']=='noDisplay')) {      $this->sessionExt[$this->formName] = array();      if (isset($this->sessionFilter)) {              // Remove filters in the same page which are not active, that is not selected or with the same contentID        reset($this->sessionFilter);        foreach ($this->sessionFilter as $keyFilter => $valueFilter) {          if ($keyFilter != $this->sessionFilterSelected &&               $valueFilter['pageID'] == $GLOBALS['TSFE']->id &&              $valueFilter['contentID'] != $this->sessionFilter[$this->sessionFilterSelected]['contentID']) {            unset($this->sessionFilter[$keyFilter]);          }        }                              if (!is_array($this->sessionFilter[$this->sessionFilterSelected])) {          unset($this->sessionFilterSelected);               } elseif (isset($this->sessionFilter[$this->sessionFilterSelected]['uid'])) {          // init uid. Used in special case          $this->uid = $this->sessionFilter[$this->sessionFilterSelected]['uid'];            $this->formAction = $this->sessionFilter[$this->sessionFilterSelected]['formAction'];            }      }    }                   // Check the POST and GET variables    $extPOSTVars = t3lib_div::_POST($this->formName);    if ($extPOSTVars['updateBtn']) {      $this->fieldFromButton = key($extPOSTVars['updateBtn']);      $temp = current($extPOSTVars['updateBtn']);      unset($_POST[$this->formName]['updateBtn']);      unset($_POST[$this->formName]['formAction']);      $this->sessionExt[$this->formName]['formAction'] = 'updateBtn';      if (is_array($temp)) {        $this->rowItemFromButton = key($temp);      }    } elseif ($extPOSTVars['saveBtn']) {      unset($_POST[$this->formName]['saveBtn']);      unset($_POST[$this->formName]['formAction']);      $this->sessionExt[$this->formName]['formAction'] = 'saveBtn';    } elseif ($extPOSTVars['formAction'] == 'saveBtn') {      unset($_POST[$this->formName]['formAction']);      $this->sessionExt[$this->formName]['formAction'] = 'saveBtn';        } elseif ($extPOSTVars['saveandcloseBtn']) {      unset($_POST[$this->formName]['saveandcloseBtn']);      unset($_POST[$this->formName]['formAction']);      $this->sessionExt[$this->formName]['formAction'] = 'saveandcloseBtn';    } else {      // Check GET variables         $extGETVars = t3lib_div::_GET($this->formName);      if (is_array($extGETVars)) {        // Get the limit for sub-form        if(isset($extGETVars['limitSub'])) {          $limitSub = $extGETVars['limitSub'];          unset($extGETVars['limitSub']);        }                // Merge the GET values        $this->sessionExt[$this->formName] = array_merge($this->sessionExt[$this->formName], $extGETVars);                // Process the browse page action        if ($extGETVars['formAction'] == 'browse' && !$extGETVars['limit']) {          $this->sessionExt[$this->formName]['limit'] = 0;        }                // Process the limit in subforms        if(isset($limitSub)) {          $this->sessionExt[$this->formName]['limitSub'][$extGETVars['field']] = $limitSub;        }      }                 }    // Clean if new variables are posted twice       if (is_array($_POST[$this->formName]) && ($this->sessionExt[$this->formName]['formAction'] == 'saveBtn' || $this->sessionExt[$this->formName]['formAction'] == 'saveandcloseBtn')) {      $temp = current($_POST[$this->formName]);      $this->isNewForm = false;      foreach ($_POST[$this->formName] as $val) {        if (!key($val)) {          $this->isNewForm = true;          break;        }      }          if ($this->isNewForm && isset($this->sessionExt[$this->formName]['lastKey']) && $this->sessionExt[$this->formName]['lastKey'] == 0) {        if (!$this->sessionExt[$this->formName]['error']) {          unset($_POST[$this->formName]);         }         } else {          $this->sessionExt[$this->formName]['lastKey'] = ($this->isNewForm ? 0 : key($temp));      }    } else {      unset($this->sessionExt[$this->formName]['lastKey']);    }    $this->formAction = ($this->sessionExt[$this->formName]['formAction'] ? $this->sessionExt[$this->formName]['formAction'] : $this->formAction);    $this->uid = ($this->sessionExt[$this->formName]['uid'] ? $this->sessionExt[$this->formName]['uid'] : $this->uid);   	$this->limit = ($this->sessionExt[$this->formName]['limit'] ? $this->sessionExt[$this->formName]['limit'] : $this->limit);  	$this->limitSub = ($this->sessionExt[$this->formName]['limitSub'] ? $this->sessionExt[$this->formName]['limitSub'] : $this->limitSub);  	$this->page = ($this->sessionExt[$this->formName]['page'] ? $this->sessionExt[$this->formName]['page'] : $this->page);    $this->inputMode = ($this->sessionExt[$this->formName]['inputMode'] ? $this->sessionExt[$this->formName]['inputMode'] : $this->inputMode);     $this->subFormName = ($this->sessionExt[$this->formName]['subFormName'] ? $this->sessionExt[$this->formName]['subFormName'] : $this->subFormName);     				// Perform actions 		if (!(t3lib_div::_GET('print') && t3lib_div::_GET('cid')) || t3lib_div::_GET('cid')==$this->extObj->cObj->data['uid']) {  		$content = $this->dispatch($this->formAction);			}	     // update session variable    $this->sessionExt[$this->formName]['inputMode'] = $this->inputMode;   	    $this->sessionExt[$this->formName]['uid'] = $this->uid;   	  	    $this->sessionExt[$this->formName]['page'] = $this->page;   	  	    $this->sessionExt[$this->formName]['limitSub'] = $this->limitSub;      $this->sessionExt[$this->formName]['error'] = $this->errorInForm;    $this->sessionExt[$this->formName]['filterSelected'] = $this->sessionFilterSelected;       	  	 	  	    if (isset($this->sessionFilterSelected)) {      unset($this->sessionFilterSelected);    }    // Set the session data    $GLOBALS['TSFE']->fe_user->setKey('ses', 'ext', $this->sessionExt);    $GLOBALS['TSFE']->fe_user->setKey('ses', 'filter', $this->sessionFilter);    $GLOBALS['TSFE']->fe_user->setKey('ses', 'filterSelected', $this->sessionFilterSelected);    $GLOBALS['TSFE']->storeSessionData();		// Add javascript for the delete warning		if ($this->inputMode) {  		$content .= (isset($GLOBALS['TSFE']->fe_user->user) ? $this->generateJSWarning($this->formName) : '');  	}    $this->extObj->prefixId .= '_' . str_replace(' ', '-', $this->extObj->extConfig['forms'][$this->conf['formId']]['title']);    return $this->extObj->pi_wrapInBaseClass($content);	}	  	/**	 * Perform action depending on the formAction  	 *	 * @param $var string (formAction)	 *	 * @return string (output)	 */	protected function dispatch($var) {		switch($var) {		  case 'inputForm':			case 'inputModeBtn':			   if ($this->uid) {				   $this->inputMode = 1; 				   $out = $this->buildForm('inputForm');         } else {				   $out = $this->buildForm('showAll');                  }		     break;			case 'editBtn':				$out = $this->buildForm('inputForm');				break;      case 'deleteItemBtn':      case 'upBtn':      case 'downBtn':			case 'saveBtn':				$errors = $this->queries_update($this->extObj->extConfig['queries'][$this->formConfig['query']]);				$this->formAction = 'inputModeBtn';				if ($this->errorInNewForm()) {				  $this->newSubForm = 1;				}				$out = $this->buildForm('inputForm', $errors);				break;			case 'saveandcloseBtn':				$errors = $this->queries_update($this->extObj->extConfig['queries'][$this->formConfig['query']]);				if ($errors) {					$out = $this->buildForm('inputForm', $errors);				} else {				  $this->inputMode = 0;					$out = $this->buildForm('showAll');				}				break;			case 'closeBtn':				$this->inputMode = (($this->inputMode==2) ? 1 : 0);				$out = $this->buildForm('showAll');				break;			case 'deleteBtn':				$this->queries_delete($this->extObj->extConfig['queries'][$this->formConfig['query']]);				$out = $this->buildForm('showAll');				break;			case 'exportBtn':			  // get the rows from a query        $func = trim($this->savlibraryConfig['viewers']['export']);    		$ta = $this->viewers->$func($rows, $this->extObj->extConfig['views'][$this->formConfig[$name]], $errors);		    // Build the form		    $out = $this->replaceTemplate($ta);		    $out = $this->wrapForm($out, $hidden, $this->formName);    					  break;			case 'newBtnSubForm':			  $this->newSubForm = 1;				$out = $this->buildForm('inputForm');				break;			case 'newBtn':        $this->uid = 0;        $this->page = '';        unset($this->sessionExt[$this->formName]['page']);				$this->inputMode = 2;				$out = $this->buildForm('inputForm');				break;			case 'changePage':			case 'rightArrowBtnSubForm':			case 'leftArrowBtnSubForm':			  if ($this->inputMode) {				  $out = $this->buildForm('inputForm');        } else {				  $out = $this->buildForm('showSingle');        }			  break;			case 'showSingle':			   $this->inputMode = 0;				$out = $this->buildForm('showSingle');				break;			case 'toggleModeBtn':				$this->inputMode = !$this->inputMode;				$out = $this->buildForm('showAll');							break;			case 'printBtn':        if ($this->uid) {				  $out = $this->buildForm('showSingle');				} else {          // Recover the selected filter if any          if ($this->sessionExt[$this->formName]['filterSelected']) {            $this->sessionFilterSelected = $this->sessionExt[$this->formName]['filterSelected'];          }          $this->conf['maxItems'] = 0; // Always display all items				  $out = $this->buildForm('showAll');                }				break;			case 'updateBtn':        			        $errors = $this->queries_update($this->extObj->extConfig['queries'][$this->formConfig['query']]);                // Call buildform twice to update all fields				$out = $this->buildForm('inputForm', $errors);				$this->titleProcessed = false;				$out = $this->buildForm('inputForm', $errors);				break;			case 'updateForm':         	$this->inputMode = 1;             $this->page = '';				$out = $this->buildForm('updateForm');				break;			case 'noDisplay':   				$out = '';				break;					default:        $this->page = '';        $out = $this->buildForm('showAll');				}		return $out;	}   /***************************************************************/   /* Form methods                                                */   /***************************************************************/	/**	 * Update TCA and get the config parameters from a field	 *	 *	 * @param $field array (field)	 * @param $opt integer (option, if not zero, the function returns only the TCA information)	 *	 * @return array (configuration for the given field)	 */	public function getConfig(&$field, $opt=0) {    if ($opt) {      // Get the config information only from the TCA      $res = explode('.', $field);		  t3lib_div::loadTCA($res[0]);		  $config = $GLOBALS['TCA'][$res[0]]['columns'][$res[1]]['config'];		  $config['table'] = $res[0];      $config['field'] = $res[1];        return $config;           }    // Get the config information from the TCA    $table = $field['config']['table'];    t3lib_div::loadTCA($table);			$config = $GLOBALS['TCA'][$table]['columns'][$field['config']['field']]['config'];    // Add or overwrite the parameters with the user's definition    if (!$config) {      $config = array();    }    // Add the columns for existing tables    if (isset($this->extObj->extConfig['TCA'][$table][$field['config']['field']])) {      $config += $this->extObj->extConfig['TCA'][$table][$field['config']['field']]['config'];    }    $config = $field['config'] + $config;    $config['_field'] = $config['table'].'.'.$config['field'];            // Add or replace with the page TSconfig if any    $pageTSConfig = $GLOBALS['TSFE']->getPagesTSconfig();    $fieldTSConfig = $pageTSConfig['tx_'.str_replace('_', '', $this->extObj->extKey) . '.'][$this->formConfig['title'] . '.'][$this->viewName . '.'][$config['field'] . '.'];    if(is_array($fieldTSConfig)) {      foreach($fieldTSConfig as $key=>$value) {        $config[strtolower($key)] = $value;      }      }		return $config;	}		/**	 * Get the viewer function to apply to a field. Function is given by the savlibraryConfig 	 *	 *	 * @param $config array (configuration)	 *	 * @return string (function to apply)	 */	public function getFunc(&$config) {      $validKey = -1;		if ($this->savlibraryConfig['itemviewers'][$config['type']]) {      foreach ($this->savlibraryConfig['itemviewers'][$config['type']] as $key => $element) {        if (!is_array($element['conditions'])) {          $validKey = $key;        } else {          $cond = 1;          foreach ($element['conditions'] as $condition) {            if (! $this->$condition['ope']($config[$condition['field']], $condition['value'])) {              $cond = 0;              break;            }          }          if ($cond) {            $validKey = $key;          }        }       }    }    if ($validKey >= 0) {      return trim($this->savlibraryConfig['itemviewers'][$config['type']][$validKey]['name']) . ($config['edit'] ? 'EditMode' : '');    } else {      $this->addError('error.unknownType', $config['type']);      return 0;    }	}  	/**	 * Generate a template array for a form based on table name and a field list	 *	 * @param $name string (name of the REGIONS)	 * @param $row array (row used to initialize the fields)	 * @param $fields array (fields to parse)   * @param $errors array (errors to display)	 * @param $editflag boolean (if true, the form can be edited)	 *	 * @return array (template array to be used in a region)	 */	public function generateFormTa($name, &$row, $fields, $errors, $editFlag) {//debug($row, 'generateFormTa -> row');//debug($fields, 'generateFormTa -> fields','','',10);		// Check if folders have been defined		if (!is_array($fields)) {		  $this->addError('error.noFieldSelectedInForm');		  return;    }		if (is_numeric(key($fields))) {		  $_fields = $fields[0]['fields'];			$ta['CUTTERS']['CUT_pagesTop'] = 1;		} else {      // Set the field based on the page. By default it is set to the first page      if ($this->page && isset($fields[$this->page]['fields'])) {        $_fields = $fields[$this->page]['fields'];      } else {        $_fields = $fields[key($fields)]['fields'];             $this->page = key($fields);       }      			foreach ($fields as $folderName => $folder) {			        // Get the folder configuration        $folderConfig = $this->getConfig($folder);        $folderConfig += $folder['config'];        if ($folderName == $this->page) {          $editFlag = (isset($folderConfig['editadminplus']) ? $this->userIsAdmin($row, 1) : $editFlag);                }                       if (is_array($folderConfig)) {          // Check if the folder must be displayed          $displayPage = !$this->checkCut($folderConfig, $row);                    if ($displayPage) {					    unset ($node);				    $node['TYPE'] = 'page';				    $node['MARKERS']['id'] = (( $this->page == $folderName) ? 'id="currentPage"' : '');	            $params = array(              'sav_library' => 1,              $this->formName . '[formAction]' => 'changePage',              $this->formName . '[page]' => $folderName,              $this->formName . '[uid]' => $this->uid,            ); 				    $node['MARKERS']['pageLink'] = preg_replace('/(<a[^>]*)>/','$1 onclick="return changePage();">',$this->extObj->pi_linkTP('<span>' . $this->getExtLL($folderName,0) . '</span>', $params, 1));				    $node['MARKERS']['pageLabel'] = $folderName;				    $ta['REGIONS']['pages'][] = $node;          } elseif ($this->page == $folderName) {            // do not display the page. Set the cutters and return			      $ta['CUTTERS']['CUT_pagesTop'] = 0;			      $ta['REGIONS'][$name]['TYPE'] = 'item';			      $ta['REGIONS'][$name]['CUTTERS']['CUT_error'] = 1;			      $ta['REGIONS'][$name]['CUTTERS']['CUT_label'] = 1;			      $ta['REGIONS'][$name]['CUTTERS']['CUT_value'] = 1;			      $ta['REGIONS'][$name]['CUTTERS']['CUT_fusionBegin'] = 1;			      $ta['REGIONS'][$name]['CUTTERS']['CUT_fusionEnd'] = 1;            return $ta;          }                 }			}			$ta['CUTTERS']['CUT_pagesTop'] = 0;		}       // Set the title    reset($fields);    $temp = current($fields);    if (!$this->titleProcessed) {      $ta['MARKERS']['formTitle'] = $this->processTitle($temp['title'], $row);      $this->titleProcessed = true;    }    // Get the submitted data (used with updateForm)      $serialSubmittedData = $this->getValue($this->tableLocal, '_submitted_data_', $row);       if ($serialSubmittedData) {      $submittedData = unserialize(html_entity_decode($serialSubmittedData,ENT_QUOTES));      if ($submittedData && array_key_exists('Temp_' . $this->formShortName, $submittedData)) {        $submittedData[$this->formShortName] = $submittedData['Temp_' . $this->formShortName];      }       }	     // Set the fields		foreach ($_fields as $key => $_field) {	  			// Get the configuration      $config = $this->getConfig($_field);			// Initialize variables and default type as input (useful when aliases are used)			$field = $config['field'];			$table = $config['table'];			$config['uid'] = $this->getValue($table, 'uid', $row);      $config['_value'] = $this->getValue($table, $field, $row);      // Check if the field has to be kept for future use in subform      if ($config['keepfieldsinsubform']) {        if ($config['keepfieldsinsubform']=='*') {          foreach ($row as $keepFieldKey => $keepFieldValue) {            $config['keepfieldsinsubformvalues'][$keepFieldKey] = $keepFieldValue;               }                 } else {          $keepFields = explode(',', $config['keepfieldsinsubform']);          foreach ($keepFields as $keepField) {            $config['keepfieldsinsubformvalues'][$keepField] = $this->getValue($table, $keepField, $row);               }        }      }  		if (!$config['type']) {				$config['type'] = 'input';			}			// Set the $edit value depending on the configuration      $edit = (isset($config['editadminplus']) ? $this->userIsAdmin($row, 1) : isset($config['edit']) ? $config['edit'] : $editFlag);        			// Generate label. $tag is the displayed field depending on the attribute "label"			unset($_value);			unset($node);			$node['TYPE'] = 'item';			$node['MARKERS']['field'] = $field;			if (is_null($config['onlabel']) || !$config['onlabel']) {				$label = $this->getLL_db('LLL:EXT:' . $this->extObj->extKey . '/locallang_db.xml:' . $config['_field']);				if($this->inputIsAllowedInForm() && ($config['required'] || $config['eval']=='required')) {					$label .= $this->iconImage('requiredIcon', 'required.gif', 'icon.required');				}				$node['MARKERS']['Label'] = $label;				$tag = ($config['tagname'] ? $field : 'Value');			} else {				$node['MARKERS']['Value'] = '';				$tag = ($config['tagname'] ? $field : 'Label');			}			// Set the message by the value of the field 			if (isset($config['fieldmessage'])) {        $config['message'] = $this->getValue($table, $config['fieldmessage'], $row);      } 			// Set the link by the value of the field 			if (isset($config['fieldlink'])) {        $config['link'] = $this->getValue($table, $config['fieldlink'], $row);      } 			// Set the alt by the value of the field 			if (isset($config['fieldalt'])) {        $config['alt'] = $this->getValue($table, $config['fieldalt'], $row);      }       // Set additional folder      if (isset($config['addtouploadfolderfromfield'])) {        $config['addtouploadfolder'] = str_replace(' ', '_', $this->getValue($table, $config['addtouploadfolderfromfield'], $row));      }      // Set the check mail value      if (isset($config['fieldforcheckmail'])) {        $config['valueforcheckmail'] = $this->getValue($table, $config['fieldforcheckmail'], $row);      }			// Substitute the value if it is an alias			if (isset($config['label'])) {				$node['MARKERS']['Label'] = $config['label'];      }			if (isset($config['alias'])) {				$value = $this->getValue($table, $config['alias'], $row);			} elseif (isset($config['value'])) {        // set the value from the config parameter and set the type to label				$value = $config['value'];				$config['type'] = 'label';						} elseif (isset($config['reqvalue'])) {        // set the value from the config parameter, which should be a request        // with a field 'value' and set the type to label        $query = $config['reqvalue'];         if (preg_match_all('/###row\[([^\]]+)\]###/', $query, $matches)) {          foreach ($matches[0] as $k => $match) {            $mA[$matches[0][$k]] = $this->getValue($table, $matches[1][$k], $row);          }        }                $mA['###uid###'] = intval($config['uid'] ? $config['uid'] : 0);        $mA['###uidParent###'] = intval($row['uid'] ? $row['uid'] : 0);        $mA['###uidItem###'] = intval($this->rowItem);        $mA['###uidSelected###'] = $this->getValue($table, $field, $row);        $mA['###user###'] = $GLOBALS['TSFE']->fe_user->user['uid'];        $query = $this->extObj->cObj->substituteMarkerArrayCached($query, $mA, array(), array());        // Check if the query is a SELECT query and for errors  		  $value='';        if (!$this->isSelectQuery($query)) {          $this->addError('error.onlySelectQueryAllowed', $config['field']);        } elseif (!($res = $GLOBALS['TYPO3_DB']->sql_query($query))) {          $this->addError('error.incorrectQueryInReqValue', $config['field']);        } else {          // Process the query          if ($GLOBALS['TYPO3_DB']->sql_error($res)) {            $this->addError('error.incorrectQueryInReqValue', $field);          } else {  		      $separator = ($config['separator'] ? $config['separator'] : '<br />');  		      while ($rows = $GLOBALS['TYPO3_DB']->sql_fetch_assoc($res)) {              if (array_key_exists('value',$rows)) {                if (isset($config['func'])) {                  $value .= ($value ? $separator : '') . $this->$config['func']($rows['value'], $rows['uid'], $config);                } else {                  $value .= ($value ? $separator : '') . $rows['value'];                }              } else {                $value = $this->getValue($table, $field, $row);                // add the result to the row                foreach($rows as $k=>$v) {                  $row[$k] = $v;                }              }            }  		    }          if (isset($config['func']))	{            unset($config['func']);          }        }      } else {				$value = $this->getValue($table, $field, $row);			}      // Wrapper on the value      if ($config['stdwrapvalue']) {        $TSparser = t3lib_div::makeInstance('t3lib_TSparser');        $TSparser->parse($config['stdwrapvalue']);        $value = $this->extObj->cObj->stdWrap($value, $TSparser->setup);      }			// Evaluate the function if necessary			if (isset($config['func'])) {        $_value = $value;        if ($value) {          $value = $config['funcaddleftifnotnull'] . $value . $config['funcaddrightifnotnull'];        } else {          $value = $config['funcaddleftifnull'] . $value . $config['funcaddrightifnull'];        }				$value = $this->$config['func']($value, ($config['setuid']=='this'? $config['_value'] : $this->getValue($table, 'uid', $row)), $config);			}      // Check if the generateRTFBtn button was activated      if ($config['generatertf'] && $key==$this->fieldFromButton && $this->formAction=='updateBtn' && ($this->rowItemFromButton ? ($this->rowItemFromButton==$this->rowItem) : 1)) {        // Get the template RTF file        if ($config['templatertf']) {          // Check the extension          $templatertf = $this->queriers->processFieldTags($config['templatertf'], $row);          $path_parts = pathinfo($templatertf);          if ($path_parts['extension'] == 'rtf') {            // Read and process the file            $value = '';            if ($file = @file_get_contents(PATH_site . $templatertf)) {              // Process ###field### tags               $file = $this->queriers->processFieldTags($file, $row, true);                                            // Write the result              if ($config['savefilertf']) {                $path_parts = pathinfo($config['savefilertf']);                // create the directories if necessary    						$dirs = explode('/',$path_parts['dirname']);    						$path = PATH_site;    						foreach($dirs as $dir){                   $path .= $dir;    						  if (!is_dir($path)) {                    if(!mkdir($path)) {                      $errors[$config['_field']][$config['uid']] = 'error.mkdirIncorrect';                    }    							}    							$path .= '/';    						}                // Process the file name                   $fileName = str_replace(' ', '_', $this->queriers->processFieldTags($path_parts['basename'], $row));                              file_put_contents($path . $fileName,$file);                              // set the evalue                $value = $fileName;              } else {                $errors[$config['_field']][$config['uid']] = 'error.incorrectRTFSaveFileName';                         }                    } else {              $errors[$config['_field']][$config['uid']] = 'error.incorrectRTFTemplateFileName';                    }          } else {            $errors[$config['_field']][$config['uid']] = 'error.incorrectRTFTemplateFileExtension';                  }        } else {          $errors[$config['_field']][$config['uid']] = 'error.incorrectRTFTemplateFileConfig';                      }      }   			// Errors			if ($errors) {        $config['errors'] = $errors;      }      $errorUid = ($config['uid'] && !$this->isNewForm ? $config['uid'] : 0);      if (is_array($errors[$config['_field']]) && $errors[$config['_field']][$errorUid]) {				$node['CUTTERS']['CUT_error'] = 0;				$node['MARKERS']['error'] = $this->getLibraryLL($errors[$config['_field']][$errorUid]);			} else {				$node['CUTTERS']['CUT_error'] = 1;			}			// Fusion of several cells			if ($this->fusionEnd) {        $this->fusion = 0;			  $this->fusionEnd = 0;      }			$this->fusionBegin = 0;			if ($config['fusion'] == 'begin') {			  $this->fusionBegin = 1;        $this->fusion = 1;      }			if ($config['fusion'] == 'end') {			  $this->fusionEnd = 1;      }      // Wrappers      $node['WRAPPERS']['wrapitem'] = $config['wrapitem'];                 			// Cutters      $config['value'] = $value;      $cut = $this->checkCut($config,$row);      $node['CUTTERS']['CUT_label'] = $cut || $config['cutlabel'];			$node['CUTTERS']['CUT_value'] = $cut;     			$node['CUTTERS']['CUT_fusionEnd'] = ($this->fusion && !$this->fusionEnd) || (((!$this->fusion && $cut) || ($this->fusion && $cut && $config['cutfusion'])) ? 1 : 0);			$node['CUTTERS']['CUT_fusionBegin'] = ($this->fusion && !$this->fusionBegin) || (((!$this->fusion && $cut) || ($this->fusion && $cut && $config['cutfusion'])) ? 1 : 0);      // Call the viewer depending on the type      $config['edit'] = $edit;      $config['name'] = $name;      $config['tag'] = $tag;		  $config['elementControlName'] = $this->formName . '[' . $config['_field'] . ']' . (isset($this->rowItem) ? '[' . $this->rowItem . ']' : '['.$config['uid'] . ']');      $config['cutvalue'] = $node['CUTTERS']['CUT_value'];      $config['subform'] = '';      // Special processing to add an editable field              $configUpdate = $config;      if ($config['addedit'] && $config['addedittype']) {        $configUpdate['type'] = $config['addedittype'];      }            if (($func = $this->getFunc($config))) {              // If a group condition is associated with the field and the user does not belong to this group, then remove the value        if ($config['usergroup'] && !in_array($config['usergroup'], $GLOBALS['TSFE']->fe_user->groupData['title'])) {          $value = '';        }        $value = $this->itemviewers->$func($config);           // Prepare the left and right contents        if ($value) {          $addLeft = $config['addleftifnotnull'];          $addRight = $config['addrightifnotnull'];        } else {          $addLeft = $config['addleftifnull'];          $addRight = $config['addrightifnull'];        }                 // Evaluate the function if necessary  			if (isset($config['funcleft'])) {  			  $config['funcspecial'] = 'left';				  $addLeft = $this->$config['funcleft']($addLeft, ($config['setuidleft']=='this'? $config['_value'] : $this->getValue($table, 'uid', $row)), $config);        }  			if (isset($config['funcright'])) {  			  $config['funcspecial'] = 'right';				  $addRight = $this->$config['funcright']($addRight, ($config['setuidright']=='this'? $config['_value'] : $this->getValue($table, 'uid', $row)), $config);        }               // Add the left and right contents                $value = $addLeft.$value.$addRight;                       // New icon         if ($config['addnewicon'] && (time() <= $this->getValue($this->tableLocal, 'crdate', $row) + $config['addnewicon'] * 86400)) {          $image = $this->iconImage('newIcon', 'newicon.gif', '');          $value = $image . $value;        }  		        // Process localization of field title on the value        preg_match_all('/\$\$\$label\[([^\]]+)\]\$\$\$/', $value, $matches);        foreach ($matches[1] as $keyMatch => $valueMatch) {          // Try with the local table          $label = $this->getLL_db('LLL:EXT:' . $this->extObj->extKey . '/locallang_db.xml:' . $this->tableLocal . '.' . $valueMatch);          if ($label) {            $value = str_replace($matches[0][$keyMatch], $label, $value);          } else {            // Try with the matching value which should be a valid tableName.fieldName tag            $label = $this->getLL_db('LLL:EXT:' . $this->extObj->extKey . '/locallang_db.xml:' . $valueMatch);            if ($label) {              $value = str_replace($matches[0][$keyMatch], $label, $value);            }          }        }        // Process localization tags on the value        $value = $this->processLocalizationTags($value);        // Add the value to the node                $node['MARKERS'][$tag] = $value;        $node['MARKERS']['subform'] = $config['subform'];        // Styles and classes        $node['MARKERS']['styleValue'] = ($config['stylevalue'] ? 'style="' . $config['stylevalue'] . '"' : '');        $node['MARKERS']['styleLabel'] = ($config['stylelabel'] ? 'style="' . $config['stylelabel'] . '"' : '');        $node['MARKERS']['classValue'] = ($config['classvalue'] ? 'class="' . $config['classvalue'] . '"' : 'class="value' . $config['subform'] . '"');  			$node['MARKERS']['classLabel'] = ($config['classlabel'] ? 'class="' . $config['classlabel'] . '"' : 'class="label"');        // Special processing for update Form)        if ($this->viewName == 'updateForm') {          $this->processUpdateForm($configUpdate, $key, $submittedData, $node);        }       }     			$ta['REGIONS'][$name][] = $node;		}		return $ta;	}	/**	 * Process the update form	 *	 * @param $config array (configuration array)	 * @param $key int (fiel key)	 * @param $submittedData array (data)	 * @param $submittedData array (output data)	 	 *	 * @return boolean (true if it should be cut)	 */  protected function processUpdateForm($config, $key, &$submittedData, &$node) {      if ($config['addedit'] || $config['addeditifnull'] || $config['addeditifadmin']) {      $savedConfig = $config;                // Get the function for the field          $function = $this->getFunc($config);      $tag = $config['tag'];            // Display the previous submitted data if any      $oldValue = html_entity_decode($config['value'], ENT_QUOTES);      if ($submittedData[$this->formShortName][$key]) {        $submittedValue = $submittedData[$this->formShortName][$key][$config['uid']];        $oldValue = html_entity_decode($config['value'], ENT_QUOTES);        // Case where a non-true MM relation is used                if (!$config['MM'] && $config['maxitems']>1) {          $submittedValue = implode(',', $submittedValue);        }                                 // Display the submitted value        $config['_value'] = $submittedValue;                $config['value'] = $submittedValue;        // process special type          // multiple checkboxes => build one integer  			if ($config['type'] == 'check' && is_array ($config['items'])) {  				$pow = 1;  				$val = 0;  				foreach($config['value'] as $checked) {            if ($checked) {              $val += $pow;            }            $pow = $pow <<1;          }          unset($config['value']);          unset($config['_value']);          $config['value'] = $val;		          $config['_value'] = $val;		          $submittedValue = $config['value'];                         }	                   // Date and datetime        if ($config['type'] == 'input' && ($config['eval'] == 'date' || $config['eval'] == 'datetime')) {                  $config['_value'] = $this->date2timestamp($config['_value'] , $config, $errorDate);          if ($errorDate) {            $config['errorDateValue'] = $config['_value'];            $config['_value'] = '';                  }              $config['value'] = $this->date2timestamp($config['value'] , $config, $errorDate);           if ($errorDate && !$config['errorDateValue']){            $config['errorDateValue'] = $config['value'];            $config['value'] = '';                  }           $submittedValue = $config['value'];                         }                    // Set the checkbox marker if information is different        if ($oldValue != $submittedValue) {              $node['MARKERS'][$tag . '_Check'] = 1;        }                  }        // Set the Field marker      $node['MARKERS'][$tag . '_Field'] = $this->formName . '[' . $config['_field'] . ']' . (isset($this->rowItem) ? '[' . $this->rowItem .']' : '[' . $config['uid'] . ']');      $node['MARKERS'][$tag . '_FieldName'] = $config['_field'];      if ($config['required']) {        $node['MARKERS'][$tag . '_Required'] = 1;      }      if ($config['checkedinupdateformadmin']) {        $node['MARKERS'][$tag . '_Checked'] = 1;      }      // Set the Edit marker                if ($config['addedit'] || ($config['addeditifnull'] && !$config['_value'])) {        $config['edit'] = 1;        $func = $function.'EditMode';        $node['MARKERS'][$tag.'_Edit'] = $this->itemviewers->$func($config);      }      if ($config['addeditifadmin'] && $this->inputIsAllowedInForm()) {        $config['edit'] = 1;        $func = $function . 'EditMode';        $node['MARKERS'][$tag . '_Edit'] = $this->itemviewers->$func($config);      }                $config = $savedConfig;      $config['_value'] = $config['default'];      $config['value'] = $config['default'];            // Display the previous submitted data with the tag New_ if any      if ($submittedData['New_' . $this->formShortName][$key]) {        $config['uid'] = '0';        $submittedValue = $submittedData['New_' . $this->formShortName][$key][$config['uid']];        $node['MARKERS'][$tag . '_Field'] = $this->formName . '[' . $config['_field'] . ']' . '[' . $config['uid'] . ']';                             // Display the submitted value        $config['_value'] = $submittedValue;                $config['value'] = $submittedValue;        // process special type          // multiple checkboxes => build one integer  			if ($config['type'] == 'check' && is_array ($config['items'])) {  				$pow = 1;  				$val = 0;  				foreach($config['value'] as $checked) {            if ($checked) {              $val += $pow;            }            $pow = $pow <<1;          }          unset($config['value']);          unset($config['_value']);          $config['value'] = $val;		          $config['_value'] = $val;		          $submittedValue = $config['value'];                         }	                   // Date and datetime        if ($config['type'] == 'input' && ($config['eval'] == 'date' || $config['eval'] == 'datetime')) {          $config['_value'] = $this->date2timestamp($config['_value'] , $config, $errorDate);                  if ($errorDate) {            $config['errorDateValue'] = $config['_value'];            $config['_value'] = '';                  }              $config['value'] = $this->date2timestamp($config['value'] , $config, $errorDate);           if ($errorDate && !$config['errorDateValue']){            $config['errorDateValue'] = $config['value'];            $config['value'] = '';                  }           $submittedValue = $config['value'];                           }        }      if (!$config['edit']) {                 $config['edit'] = 1;        $func = $function.'EditMode';      }      $config['uid'] = '0';      $config['elementControlName'] = $this->formName . '[' . $config['_field'] . ']' . (isset($this->rowItem) ? '[' . $this->rowItem . ']' : '[' . $config['uid'].']');      $node['MARKERS'][$tag . '_New'] = str_replace($this->formName . '[' . $config['_field'] . '][0]', 'New_' . $this->formName . '[' . $config['_field'] . '][0]', $this->itemviewers->$func($config));    }  else {      // Set the field name marker      $tag = $config['tag'];      $node['MARKERS'][$tag . '_FieldName'] = $config['_field'];    }  }	/**	 * Check if a field must be cut	 *	 * @param $config array (configuration array)	 * @param $data array (data)	 *	 * @return boolean (true if it should be cut)	 */  public function checkCut(&$config, &$data) {    $cut = 0;      // Process cutif    if ($config['cutif']) {      // Split the expressions on | or &      preg_match_all('/(\||&)?([^\|&]+)/', $config['cutif'], $matchesExp);      foreach ($matchesExp[2] as $keyMatchExp => $matchExp) {        // Get the operator between expressions        $operatorExp = $matchesExp[1][$keyMatchExp];        // Split the expression        preg_match('/(###)?([^#]*?)(=|!=|<-|!<-)(.+)$/', $matchExp, $match);        $metatag = $match[1];        $lvalue = trim($match[2]);        $operator = $match[3];        $rvalue = trim($match[4]);        if($rvalue == 'EMPTY') {          $rvalue = '';        }        if ($metatag) {          // Process the tag ###usergroup### or ###group###           $rvalue = str_replace('###', '', $rvalue);                                                  if ($lvalue == 'usergroup') {            $rows = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows(              /* SELECT   */	'uid',        			/* FROM     */	'fe_groups',        	 		/* WHERE    */	'title="' . $rvalue . '"'  		      );            $condValue = in_array($rows[0]['uid'],explode(',', $GLOBALS['TSFE']->fe_user->user['usergroup']));                 } elseif ($lvalue == 'group') {            $rows = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows(              /* SELECT   */	'uid',        			/* FROM     */	'fe_groups',        	 		/* WHERE    */	'title="' . $rvalue . '"'  		      );            $condValue = in_array($rows[0]['uid'], explode(',', $this->getValue($this->tableLocal, 'usergroup', $data)));          }        } else {                          // Replace the tag ###user### if any          if ($rvalue == '###user###') {            $rvalue = str_replace('###user###', $GLOBALS['TSFE']->fe_user->user['uid'], $rvalue);          }                         // Replace the tag ###cruser### if any. Same as ###user### but check if is a new record          if ($rvalue == '###cruser###') {            if (!$data['uid']) {                                 continue;       // This case can occur if a cutter is set and a new item is input. The condition is skipped                        } else {              $rvalue = str_replace('###cruser###', $GLOBALS['TSFE']->fe_user->user['uid'], $rvalue);            }          }                    // Get the table name and the field          if(strpos($lvalue, '.') === false) {            // Add local table by default if it is not an alias            $lvalue = (array_key_exists($lvalue, $data) ? '.' . $lvalue : $this->tableLocal . '.' . $lvalue);          }          $temp = explode('.', $lvalue);		      t3lib_div::loadTCA($temp[0]);		      $lvalueConfig = $GLOBALS['TCA'][$temp[0]]['columns'][$temp[1]]['config'];          switch($operator) {            // Check the lvalue is equal to the rvalue            case '=':            case '!=':              $lvalue = $this->getValue($temp[0], $temp[1], $data);              $condValue = ($lvalue == $rvalue);              break;                          // Check if the rvalue belongs to the lvalue considered as a set            case '<-':            case '!<-':              // Process the field value according to the type              switch ($lvalueConfig['type']){                case 'select':                          case 'group':                  if ($data['uid']) {                    $MM_table = $lvalueConfig['MM'];                    // Check if it's a true MM relation                    if ($MM_table){                      $res = $GLOBALS['TYPO3_DB']->exec_SELECTquery(                        /* SELECT   */	'uid_foreign',        				        /* FROM     */	$MM_table,                        /* WHERE    */	'uid_local=' . intval($data['uid']) . ' AND uid_foreign ' . (($operator == '!<-') ? 'IN' : 'NOT IN') . ' (' . $rvalue . ')'  		                );                      $condValue = ($GLOBALS['TYPO3_DB']->sql_num_rows($res)>=1);                    } else {                      $condValue = in_array($rvalue, explode(',', $this->getValue($temp[0], $temp[1], $data)));                    }                  } else {                    $condValue = ($operator == '<-' ? 1 : 0); // Cut by default                  }              }              break;                               }        }                      // Set the condition flag             if((($operator == '=' || $operator == '<-') && $condValue) ||(($operator == '!=' || $operator == '!<-') && !$condValue)) {          $cond = 1;        } else {          $cond = 0;        }        // Set the cutter according to the operator condition                        if (!$operatorExp || $operatorExp == '|') {          $cut = ($cut || $cond);        } else {          $cut = ($cut && $cond);        }                }    }    // Process cutifnull  		if ($config['cutifnull']) {      $cut = $cut | (isset($config['_value']) ? !$config['_value'] : !$config['value']);    }            return $cut;   }	/**	 * Check if there is a table name in the field. If not, add the table name in the config to the field name	 *	 * @param $tableName string (table name)	 * @param $fieldName string (field name)	 * @param $data array (data in which the value should be found)	 *	 * @return mixed (the field value)	 */  public function getValue($tableName, $fieldName, &$data) {    if (!is_array($data)) {      return '';    }      if (strpos('.', $fieldName) === false) {      if (array_key_exists($tableName . '.' . $fieldName, $data)) {        return $data[$tableName . '.' . $fieldName];      } else {        // It is an alias        return $data[$fieldName];      }    } else {      return $data[$fieldName];    }  }	/**	 * Process the title field of a view. It replaces tags including language tags by their values	 *	 * @param $title string (title field to process)	 * @param $data array (data in which the value should be found)	 *	 * @return string (Title after processing)	 */  public function processTitle($title, &$data) {    $out = '';    if (is_array($title)) {      $titleStr = $title['config']['field'];			// Check if ###self### or ###this### reference is used      preg_match_all('/###this\[([^\]]*)\]###/', $titleStr, $matches);      foreach($matches[0] as $key => $match) {        $urlParameters = array();        if ($matches[1][$key]) {           $temp = explode('=', $matches[1][$key]);          $urlParameters = array($this->formName . '[' . $temp[0] . ']' => $temp[1]);        }             $titleStr = str_replace($matches[0][$key], $this->extObj->cObj->getTypoLink_URL($GLOBALS['TSFE']->page['uid'], $urlParameters), $titleStr);       }            			      $titleStr = str_replace('###self###', $this->extObj->cObj->getTypoLink_URL($GLOBALS['TSFE']->page['uid']), $titleStr);       $titleStr = str_replace('###this###', $this->extObj->cObj->getTypoLink_URL($GLOBALS['TSFE']->page['uid']), $titleStr);             // Check if language tags are used      $titleStr = preg_replace('/\$\$\$([^]+)\$\$\$/e', '$this->getExtLL(\'$1\')', $titleStr);      // Check if metatags are used      preg_match_all('/###([^\.#]+)[\.]?([^#]*)###/', $titleStr, $matches);      $temp['config'] = $title['config'];      foreach($matches[0] as $key => $match) {        if ($matches[2][$key]) {          // Get the configuration field if any          $temp = $this->extObj->extConfig['views'][$this->formConfig[$this->viewName]][$this->page ? $this->page : 0]['fields'][$matches[1][$key] . '.' . $matches[2][$key]];          if (!is_array($temp)) {            $temp['config'] = array(              'table' => $matches[1][$key],              'field' => $matches[2][$key],            );          }          $config = $this->getConfig($temp);          $config['_value'] = $this->getValue($config['table'], $config['field'], $data);          $config['value'] = $this->getValue($config['table'], $config['field'], $data);          // If it's a showAll view, the field tags should be replaced by their labels          if ($this->viewName=='showAll') {            $mA[$match] = $this->getLL_db('LLL:EXT:' . $this->extObj->extKey . '/locallang_db.xml:' . $config['_field']);            // Check if an orderLinkInTitle was added in the configuration.            if ($config['orderlinkintitle']) {              preg_match('/([^+]*)(\+)?/', t3lib_div::_GET('where'), $matchDesc);                $params = array(                'sav_library' => 1,                'where' => $config['field'].($matchDesc[2] ? '-' : '+'),              );                        $mA[$match] = $this->extObj->pi_linkTP($mA[$match], $params);            }          } elseif ($func = $this->getFunc($config)) {            $mA[$match] = $this->itemviewers->$func($config);          }        } else {          // If it's a showAll view, the field tags should be replaced by their labels          if ($this->viewName == 'showAll') {            // use the localTable by default            $mA[$match] = $this->getLL_db('LLL:EXT:'.$this->extObj->extKey . '/locallang_db.xml:' . $this->tableLocal . '.' . $matches[1][$key]);          } else {            // It's an alias, just get the value            $mA[$match] =  $data[$matches[1][$key]];                            }        }      }      $out = $this->extObj->cObj->substituteMarkerArrayCached($titleStr, $mA, array(), array() );    }        return ($out ? $out : '&nbsp;');  }	/**	 * Generate the form from an identifier 	 *	 * @param $name string (identifier)	 * @param $error string (errors if any)	 *	 * @return string (the whole content result, wraped as plugin)	 */	public function buildForm($name, $errors=''){    // Save the name    $this->viewName = $name;  		// get the rows from a query    $func = trim($this->savlibraryConfig['queriers']['select'][$name]);		$rows = $this->queriers->$func($this->extObj->extConfig['queries'][$this->formConfig['query']], $this->uid);				// Check for errors in query		if ($rows === false) {		  $this->addError('error.incorrectQuery', $name . ' ('. $this->extObj->extKey . ')');      return $this->showErrors();    }    // make html special characters for all output		$rows = $this->hscRecurs($rows);		// get the view from the rows		if (!$this->formConfig[$name]) {		  $this->addError('error.unknownFormName', $name);		        return $this->showErrors();    }    $func = trim($this->savlibraryConfig['viewers'][$name]);  		$ta = $this->viewers->$func($rows, $this->extObj->extConfig['views'][$this->formConfig[$name]], $errors);    // Remove void lines    $out = $this->replaceTemplate($ta);		$out = preg_replace('/[ ]+[\n\r]+/', '', $out);				// Build the form		$out = $this->wrapForm($out, $hidden, $this->formName);		    return $out;			}	   	/**	 * Wrap views to get a form with name 	 *	 * @param $content string (content of the form)	 * @param $hidden array (hidden fields for the form)	 * @param $name string (name of the form)	 * @param $url string (url associated with the action attribute)	 *	 * @return string (the whole content result)	 */	protected function wrapForm($content, $hidden=array(), $name='', $url='#') {    $htmlArray = array();     // process hiedden parameters       if (count($hidden)) {       foreach($hidden as $key=>$value) {        $hiddenParams .= $this->hiddenField($key, $value);      }     }        // Display messages if any     if (count($this->messages)) {      $htmlArray[] = $this->showMessages();       }        // Display erros if any    if (count($this->errors)) {      $htmlArray[] = $this->showErrors();       }         // Display the form          $htmlArray[] = '<form method="post" name="' . $name . '" enctype="multipart/form-data" action="' . htmlspecialchars($GLOBALS['TSFE']->anchorPrefix . $url) . '" >';    if ($hiddenParams) {      $htmlArray[] = $hiddenParams;    }     // Display the content    $htmlArray[] = $content;    $htmlArray[] = '</form>';       		return implode($this->WRAP, $htmlArray);	}	/***************************************************************/	/* Admin methods                                               */	/***************************************************************/	/**	 * Check if the user is a plugin Administrator for the field 	 *	 * @param $data (data in which the InputAdminField value is searched)	 * @param $plus (if not null, check if the user is an Administrator + for the field)	 *	 * @return boolean ()	 */	public function userIsAdmin(&$data, $plus=0) {    if (!$this->conf['inputAdminField']) {       return true;  // if no Admin field, return true        } else {      $dataValue = $data[$this->conf['inputAdminField']];      // Check if the admin field is as alias else use the localTable      if (strpos('.', $this->conf['inputAdminField']) === false) {        if (!array_key_exists($this->conf['inputAdminField'], $data)) {          $dataValue = $this->getValue($this->tableLocal, $this->conf['inputAdminField'], $data);        }      }      $fieldValue = html_entity_decode($dataValue.($plus ? '+' : ''), ENT_QUOTES);	          // An Admin field was set. Check if the user TS config contains either the field value or * (super admin)  		$inputAdminConf = $GLOBALS['TSFE']->fe_user->getUserTSconf();      // Check if the user has the super admin attribute  		if ($inputAdminConf[$this->extObj->extKey.'_Admin']=='*') {  		  return true;      }            // Check if the fied value is set      if (!$fieldValue) {        return false;      }      // Condition on date   		    $time = time();      $cond_inputDate = ($this->conf['inputStartDate'] && ($time >= $this->conf['inputStartDate'])) && ($this->conf['inputEndDate'] && ($time <= $this->conf['inputEndDate']));       // Check if the inputAdminField is a special field      switch ($this->conf['inputAdminField']) {        case 'cruser_id':          // Check if the user created the record          if ($fieldValue==$GLOBALS['TSFE']->fe_user->user['uid']) {            return true;          } else {            return false;          }          break;      }        // Check if the user has the admin attribute  		// The operator === is used because of the possibility to have the field in first place. See php documentation for strpos().  		if (strpos($inputAdminConf[$this->extObj->extKey . '_Admin'], $fieldValue) === false) {  			return false;  		} else {  			return ($plus ? ($this->conf['inputApplyLimit'] ? $cond_inputDate : true) : true);  		}  	}	}	/**	 * Check if the user is allowed to export data 	 *	 * @ (none)	 *	 * @return boolean ()	*/  public function userIsAllowedToExportData() {  	$inputAdminConf = $GLOBALS['TSFE']->fe_user->getUserTSconf();  	        // Condition on inputAdminConf    $cond_inputAdminConf =  ($inputAdminConf[$this->extObj->extKey . '_Export']=='*');        return $cond_inputAdminConf;  }	/**	 * Check if the user is allowed to change data in the form	 *	 * @ (none)	 *	 * @return boolean ()	*/  public function userIsAllowedToInputData() {    define ('NOBODY', 0);    define ('ALL', 1);    define ('ADMIN_PLUS_USER', 2);    define ('ALL_EXCLUDING_SUPER_ADMIN', 3);  	$inputAdminConf = $GLOBALS['TSFE']->fe_user->getUserTSconf();    // Condition on date   		  $time = time();    $cond_inputDate = ($this->conf['inputStartDate'] && ($time >= $this->conf['inputStartDate'])) && ($this->conf['inputEndDate'] && ($time <= $this->conf['inputEndDate']));  	switch ($this->conf['inputApplyLimit']) {  	  case NOBODY:        $cond_inputDate = 1;      case ALL: // The condition is applied to all users including super Admin        break;      case ADMIN_PLUS_USER: // The condition will be checked in userIsAdmin and applied to admin Plus users        $cond_inputDate = 1;        break;      case ALL_EXCLUDING_SUPER_ADMIN: // Check if the user is super Admin.        $cond_inputDate = ($inputAdminConf[$this->extObj->extKey . '_Admin']=='*' ? 1 : $cond_inputDate);        break;    } 	  	// Condition on allowedGroups    $res = (array_intersect(explode(',', $this->conf['allowedGroups']), array_keys($GLOBALS['TSFE']->fe_user->groupData['uid'])) ? 1 : 0);    $cond_allowedGroups = ($this->conf['allowedGroups'] ? $res : 1);        return $this->conf['inputOnForm'] && $cond_allowedGroups && $cond_inputDate;  }		/**	 * Check if input is allowed in the form	 *	 * @ (none)	 *	 * @return boolean ()	*/	public function inputIsAllowedInForm() {    if ($this->conf['allowedGroups']) {      $res = (array_intersect(explode(',', $this->conf['allowedGroups']), array_keys($GLOBALS['TSFE']->fe_user->groupData['uid'])) ? 1 : 0);        if ($res) {        return $this->inputMode ;            } else {        return 0;      }    } else {      return $this->conf['inputOnForm'] && $this->inputMode ;    }	}	/**	 * Check if the user belongs to an allowed group	 *	 * @ (none)	 *	 * @return boolean ()	*/	public function userBelongsToAllowedGroup() {    if ($this->conf['allowedGroups']) {      $res = (array_intersect(explode(',', $this->conf['allowedGroups']), array_keys($GLOBALS['TSFE']->fe_user->groupData['uid'])) ? 1 : 0);         if ($res) {        return 1 ;            } else {        return 0;      }    } else {      return 0 ;    }	}	/***************************************************************/	/* Language methods                                            */	/***************************************************************/	/**	 * Get the TCA label.	 *	 * @param $TCAlabel string (TCA field label)	 *	 * @return string (label)	 */	public function getLL_db($TCAlabel) {			return($GLOBALS['TSFE']->sL($TCAlabel));	}	/**	 * Get the label in the locallang.xml file in the sav_library or in the sav_library_extends if loaded	 *	 * @param $label string (label)	 * @param $addMessage string (additional message)	 *	 * @return string (label)	 */  public function getLibraryLL($label, $addMessage='') {    $message = $GLOBALS['TSFE']->sL('LLL:EXT:sav_library/locallang.xml:' . $label);    if (!$message) {      if (t3lib_extMgm::isLoaded('sav_library_extends')) {        $message = $GLOBALS['TSFE']->sL('LLL:EXT:sav_library_extends/locallang.xml:' . $label);      }       if (!$message) {        $this->addError('error.missingLabel', $label);        return '';      }    }      return $message.$addMessage;  }	/**	 * Get the label in the locallang.xml file in the extension.	 *	 * @param $label string (label)	 * @param $error string (If set and the label does not exist, an error message is produced)	 *	 * @return string (label)	 */    public function getExtLL($label, $error='1') {      return (($message = $this->extObj->pi_getLL($label)) ? $message : ($error ? $this->addError('error.missingLabel', $label) : $label));  } 	/**	 * Process localization tags	 *	 * @param $value string (string to process)	 *	 * @return string ()	 */  public function processLocalizationTags($value) {    preg_match_all('/\$\$\$([^\$]+)\$\$\$/', $value, $matches);        foreach ($matches[1] as $keyMatch => $valueMatch) {      $label = $this->getExtLL($valueMatch);      $value = str_replace($matches[0][$keyMatch], $label, $value);    }          return $value;  }    	/***************************************************************/	/* Message and error methods                                   */	/***************************************************************/  	/**	 * Transform an array of HTML code into HTML code	 *	 * @return  string	 */  public function arrayToHTML($htmlArray, $noHTMLprefix=false) {    if ($noHTMLprefix) {		  return  implode('', $htmlArray);    } else {		  return  implode($this->EOL . $this->SPACE, $htmlArray);    }  }	/**	 * Add a message to the messagess array	 *	 * @param $messageLabel string (message label)	 * @param $addMessage string (additionalmessage)	 *	 * @return  (none)	 */  public function addMessage($messageLabel, $addMessage='', $class='') {      $message['text'] = $this->getLibraryLL($messageLabel, $addMessage);    $message['class'] = $class;    $this->messages[] = $message;  }	/**	 * Add an error to the errors array	 *	 * @param $errorLabel string (error label)	 * @param $addMessage string (additionalmessage)	 *	 * @return none	 */  public function addError($errorLabel, $addMessage='') {      $this->errors[] = $this->getLibraryLL($errorLabel, $addMessage);  }  	/**	 * Display the errors	 *	 * @ (none)	 *	 * @return string (error list)	 */	public function showErrors() {			if(!$this->errors) {			return '';		} else {		  // Errors		  if ($this->errors) {		    $htmlArray = array();  			$htmlArray[] = '<div class="sav-library-errors">';        $htmlArray[] = '  <ul>';  			foreach($this->errors as $error) {          $htmlArray[] = '    <li class="error">' . $error . '</li>';        }        $htmlArray[] = '  </ul>';        $htmlArray[] = '</div>';      }      			return $this->arrayToHTML($htmlArray);		}	}	/**	 * Display the messages	 *	 * @ (none)	 *	 * @return string (message list)	 */	public function showMessages() {		if(!$this->messages) {			return '';		} else {				  // Messages		  if ($this->messages) {		    $htmlArray = array();  			$htmlArray[] = '<div class="sav-library-messages">';  			$htmlArray[] = '  <ul>';  			foreach($this->messages as $message) {          $htmlArray[] = '    <li class="' . ($message['class'] ? $message['class'] : 'message') . '">' . $message['text'] . '</li>';        }        $htmlArray[] = '  </ul>';        $htmlArray[] = '</div>';      }					return $this->arrayToHTML($htmlArray);		}	}	/**	 * Return true if there is an error in a new form	 *	 * @ (none)	 *	 * @return boolean (True in case of error)	 */  public function errorInNewForm() {    return $this->errorInForm && $this->isNewForm;  }	/***************************************************************/	/* Other methods                                               */	/***************************************************************/		/**	 * Convert a date into timestamp	 *	 * @param $date string (date to convert)	 * @param $config array (configuration)	 * @param $error string (out parameter - error message)	 *	 * @return integer (timestamp)	 */	public function date2timestamp($date , &$config, &$error) { 		// Provide a default format    if (!$config['format']){      $format = ($config['eval']=='date' ? '%d/%m/%Y' : '%d/%m/%Y %H:%M');    } else {      $format = $config['format'];    }  		// Variable array   		$var = array(		  'd' => array('type' => 'day', 'pattern' => '([0-9]{2})'),		  'e' => array('type' => 'day', 'pattern' => '([ 0-9][0-9])'),		  'H' => array('type' => 'hour', 'pattern' => '([0-9]{2})'),		  'I' => array('type' => 'hour', 'pattern' => '([0-9]{2})'),		  'm' => array('type' => 'month', 'pattern' => '([0-9]{2})'),		  'M' => array('type' => 'minute', 'pattern' => '([0-9]{2})'),		  'S' => array('type' => 'second', 'pattern' => '([0-9]{2})'),		  'Y' => array('type' => 'year', 'pattern' => '([0-9]{4})'),		  'y' => array('type' => 'year_without_century', 'pattern' => '([0-9]{2})'),		  );		// Intialise the variables		foreach ($var as $key => $val) {			$$val = 0;		}    // Build the expression to match the string according to the format    preg_match_all('/%([deHImMSYy])([^%]*)/', $format, $matchesFormat);    $exp = '/';    foreach ($matchesFormat[1] as $key => $match) {      $exp .= $var[$matchesFormat[1][$key]]['pattern'] . '(?:' . str_replace('/', '\/',$matchesFormat[2][$key]) . ')';    }    $exp .= '/';		$out = 0;    if ($date) {      if(!preg_match($exp, $date, $matchesDate)) {  			$error = 'error.incorrectDateFormat';  			return $date;          } else {        unset($matchesDate[0]);        foreach($matchesDate as $key => $match) {          $res[$matchesFormat[1][$key-1]] = $match;        }         }		  // set the variables		  foreach($res as $key => $val) {        if(array_key_exists($key, $var)) {          $$var[$key]['type'] = $val;				  } else {					$error = 'error.incorrectDateOption';          return '';                }		  }		  // deal with year without century		  if ($year_without_century && !$year) {			  $year = 2000 + $year_without_century;		  }					  $out = mktime($hour, $minute, $second, $month, $day, $year);    }    return $out;	}  	/***************************************************************/	/* Button methods                                              */	/***************************************************************/	/**	 * iconImage	 *	 * @param $class string (class name attribute)	 * @param $file string (icon file name)	 * @param $label string (label to use for title and alt)	 * @param $attributes string (additional attributes)	 *	 * @return string (img-tag for the icon)	 */    public function iconImage($class, $file, $label, $attributes='') {      $str = ($label ? $this->getLibraryLL($label) : '');        $out = '<img class="' . $class . '" src="' . $this->iconsDir . $file . '" title="' . $str . '" alt="' . $str . '" ' . $attributes . ' />';        return $out;  }	/**	 * Edit button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Edit link)	 */	public function editButton($formName, $uid) {    $image = $this->iconImage('editButton', 'edit.gif', 'button.edit');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'editBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Save button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Save link)	 */	public function saveButton($formName, $uid) {			$out = '<input type="image" class="saveButton" name="'.$formName.'[saveBtn]" onclick="updateTextareaRTE();'.$this->selectList.'" src="'.$this->iconsDir.'savedok.gif" title="'.$this->getLibraryLL('button.save').'" alt="'.$this->getLibraryLL('button.save').'" />';    return $out;	}	/**	 * Save and close button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Save and close link)	 */	public function saveandcloseButton($formName, $uid) {				$out = '<input type="image" class="saveandcloseButton" name="'.$formName.'[saveandcloseBtn]" onclick="updateTextareaRTE();'.$this->selectList.'" src="'.$this->iconsDir.'saveandclosedok.gif" title="'.$this->getLibraryLL('button.saveandclose').'" alt="'.$this->getLibraryLL('button.saveandclose').'" />';    return $out;	}	/**	 * Mail button	 *	 * @param $formName string (name of the form)	 * @param $fieldName string (Field name)	 * @param $value (if there is no value, display an icon indicating that mail is off)	 * @param $uid integer (uid)	 *	 * @return string (Mail link)	 */	public function mailButton ($formName, $fieldName, $value, $uid) {	    if ($value) {  		$out = '<input type="image" class="mailButton" name="'.$formName.'[updateBtn]['.$fieldName.']'.($uid ? '['.$uid.']' : '').'" onclick="updateTextareaRTE();'.$this->selectList.'" src="'.$this->iconsDir.'newmail.gif" title="'.$this->getLibraryLL('button.mail').'" alt="'.$this->getLibraryLL('button.mail').'" />';    } else {      $out = $this->iconImage('mailButton', 'newmail_off.gif', 'button.mail');    }        return $out;	}	/**	 * generateRTF button	 *	 * @param $formName string (name of the form)	 * @param $fieldName string (Field name)	 * @param $uid integer (uid)	 *	 * @return string (Generate RTF link)	 */	public function generateRTFButton ($formName, $fieldName, $uid) {	  	$out = '<input type="image" class="generateRTFButton" name="'.$formName.'[updateBtn]['.$fieldName.']'.($uid ? '['.$uid.']' : '').'" onclick="updateTextareaRTE();'.$this->selectList.'" src="'.$this->iconsDir.'generatertf.gif" title="'.$this->getLibraryLL('button.generateRTF').'" alt="'.$this->getLibraryLL('button.generateRTF').'" />';    return $out;	}		/**	 * Close button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Close link)	 */	public function closeButton($formName, $uid) {	    $image = $this->iconImage('closeButton', 'closedok.gif', 'button.close');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'closeBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * Export button	 *	 * @param $formName string (name of the form)	 *	 * @return string (Export link)	 */  public function exportButton($formName) {	    $image = $this->iconImage('exportButton', 'export.gif', 'button.export');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'exportBtn',    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * Exportok button	 *	 * @param $formName string (name of the form)	 *	 * @return string (Exportok link)	 */	public function exportokButton($formName) {			$out = '<input type="image" class="exportokButton" name="'.$formName.'[exportokBtn]" onclick="updateTextareaRTE();'.$this->selectList.'" src="'.$this->iconsDir.'exportok.gif" title="'.$this->getLibraryLL('button.export').'" alt="'.$this->getLibraryLL('button.export').'" />';    return $out;	}	/**	 * New button	 *	 * @param $formName string (name of the form)	 *	 * @return string (New link)	 */	public function newButton($formName) {	    $image = $this->iconImage('newButton', 'new.gif', 'button.new');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'newBtn',    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * New button in subform	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 * @param $subformName string (name of the subform) 	 *	 * @return string (New in subform link)	 */	public function newButtonSubForm($formName, $uid, $subformName) {    $onClick = 'onclick="return changePage();"';    $image = $this->iconImage('newButtonSubForm', 'new.gif', 'button.new', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'newBtnSubForm',      $this->formName . '[uid]' => $uid,      $this->formName . '[subFormName]' => $subformName,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Left arrow button	 *	 * @param $formName string (name of the form)	 * @param $limit integer (limit parameter of formName) 	 *	 * @return string (Left arrow link)	 */	public function leftArrowButton($formName, $limit) {    $image = $this->iconImage('leftArrowButton', 'leftarrow.gif', 'button.leftArrow');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'leftArrowBtn',      $this->formName . '[limit]' => $limit,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * Left arrow button in subform	 *	 * @param $formName string (name of the form)	 * @param $limit integer (limitSub parameter of formName)	 * @param $uid integer (uid parameter of formName) 	 *	 * @return string (Left arrow link in subform)	 */	public function leftArrowButtonSubForm($formName, $limit, $uid, $field='') {    $onClick = 'onclick="return changePage();"';    $image = $this->iconImage('leftArrowButtonSubForm', 'leftarrow.gif', 'button.leftArrow', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'leftArrowBtnSubForm',      $this->formName . '[limitSub]' => $limit,      $this->formName . '[uid]' => $uid,      $this->formName . '[field]' => $field,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Right arrow button	 *	 * @param $formName string (name of the form)	 * @param $limit integer (limit parameter of formName) 	 *	 * @return string (Right arrow link)	 */	public function rightArrowButton($formName, $limit) {    $image = $this->iconImage('rightArrowButton', 'rightarrow.gif', 'button.rightArrow');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'rightArrowBtn',      $this->formName . '[limit]' => $limit,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Right arrow button in subform	 *	 * @param $formName string (name of the form)	 * @param $limit integer (limitSub parameter of formName)	 * @param $uid integer (uid parameter of formName) 	 *	 * @return string (Right arrow link in subform)	 */	public function rightArrowButtonSubForm($formName, $limit, $uid, $field='') {    $onClick = 'onclick="return changePage();"';    $image = $this->iconImage('rightArrowButtonSubForm', 'rightarrow.gif', 'button.rightArrow', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'rightArrowBtnSubForm',      $this->formName . '[limitSub]' => $limit,      $this->formName . '[uid]' => $uid,      $this->formName . '[field]' => $field,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * Delete button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Delete link)	 */	public function deleteButton($formName, $uid) {    $onClick = 'onclick="return confirm(\'' . $this->getLibraryLL('warning.delete') . '\');"';    $image = $this->iconImage('deleteButton', 'deletedok.gif', 'button.delete', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'deleteBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Input mode button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Input mode link)	 */	public function inputModeButton($formName, $uid) {    $image = $this->iconImage('inputModeButton', 'toggle.gif', 'button.inputMode');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'inputModeBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Toggle mode button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Toggle mode link)	 */	public function toggleModeButton($formName, $uid) {    $image = $this->iconImage('toggleModeButton', 'toggle.gif', 'button.toggleMode');    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'toggleModeBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Search button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Search link)	 */	public function searchButton($formName, $uid) {		$out = '<input type="image" onclick="document.'.$formName.'.formAction.value=\'searchBtn\';document.'.$formName.'.uid.value='.$uid.';" class="searchButton" name="_search" src="'.$this->iconsDir.'search.gif" title="'.$this->getLibraryLL('button.search').'" alt="'.$this->getLibraryLL('button.search').'" />';    return $out;	}	/**	 * Print button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Print link)	 */	public function printButton($formName, $uid) {	    $image = $this->iconImage('printButton', 'print.gif', 'button.print');    $params = array(      'sav_library' => 1,      'print' => 1,      'cid' => $this->extObj->cObj->data['uid'],      $this->formName . '[formAction]' => 'printBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}		/**	 * Help button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Help link)	 */	public function helpButton($formName, $uid) {	    $onClick = 'onclick="vHWin=window.open(\''.htmlentities($this->extObj->pi_getPageLink($this->conf['helpPage'], '', array('help'=>1))).'\',\'viewHelp\',\'height=500,width=600,status=0,menubar=0,scrollbars=1\');vHWin.focus();return false;"';    $image = $this->iconImage('helpButton', 'helpbubble.gif', 'button.help', $onClick);          $params = array(      'sav_library' => 1,           $this->formName . '[formAction]' => 'helpBtn',      $this->formName . '[uid]' => $uid,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Up button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 * @param $uidItem integer (uidItem parameter of formName)	 * @param $field string (field parameter of formName)	 *	 * @return string (Up link)	 */	public function upButton ($formName, $uid, $uidItem, $field='') {    $onClick = 'onclick="return changePage();"';    $image = $this->iconImage('upButton', 'up.gif', 'button.up', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'upBtn',      $this->formName . '[uid]' => $uid,      $this->formName . '[uidItem]' => $uidItem,      $this->formName . '[field]' => $field,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Down button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 * @param $uidItem integer (uidItem parameter of formName)	 * @param $field string (field parameter of formName)	 *	 * @return string (Down link)	 */	public function downButton ($formName, $uid, $uidItem, $field='') {    $onClick = 'onclick="return changePage();"';    $image = $this->iconImage('downButton', 'down.gif', 'button.down', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'downBtn',      $this->formName . '[uid]' => $uid,      $this->formName . '[uidItem]' => $uidItem,      $this->formName . '[field]' => $field,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Delete item button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 * @param $uidItem integer (uidItem parameter of formName)	 * @param $field string (field parameter of formName)	 *	 * @return string (Delete item link)	 */	public function deleteItemButton ($formName, $uid, $uidItem, $field='') {    $onClick = 'onclick="return confirm(\'' . $this->getLibraryLL('warning.delete') . '\');"';    $image = $this->iconImage('deleteItemButton', 'deletedok.gif', 'button.deleteItem', $onClick);    $params = array(      'sav_library' => 1,      $this->formName . '[formAction]' => 'deleteItemBtn',      $this->formName . '[uid]' => $uid,      $this->formName . '[uidItem]' => $uidItem,      $this->formName . '[field]' => $field,    );     $out = $this->extObj->pi_linkTP($image, $params, 1);    		return $out;	}	/**	 * Submit Form button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Submit Form button)	 */	public function submitButton($formName, $uid) {			$out = '<input type="submit" class="submitButton" value="' . $this->getLibraryLL('button.submit') . '" />';		$out .= $this->hiddenField($formName.'[formAction]', 'updateForm');				return $out;  }	/**	 * Submit Admin Form button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Submit Admin Form button)	 */	public function submitAdminButton($formName, $uid) {			$out = '<input type="image" class="submitAdminButton" name="'.$formName.'[submitAdminBtn]" src="'.$this->iconsDir.'submitadmin.gif" title="'.$this->getLibraryLL('button.submit').'" alt="'.$this->getLibraryLL('button.submit').'" />';		$out .= $this->hiddenField($formName.'[formAction]', 'updateFormAdmin');				return $out;  }	/**	 * User Submit Form button	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Submit Form button)	 */	public function user_submitButton($formName, $uid) {			$out = '<input type="submit" class="submitButton" value="' . $this->getLibraryLL('button.submit') . '" />';		$out .= $this->hiddenField($formName . '[formAction]', 'updateForm' . ($this->inputIsAllowedInForm() ? 'Admin' : ''));				return $out;  }  	/**	 * Save export configuration	 *	 * @param $formName string (name of the form)	 *	 * @return string (Save link)	 */	public function saveExportConfiguration($formName) {			$out = '<input type="image" class="saveExportConfiguration" name="' .$formName.'[saveExportConfiguration]" src="'.$this->iconsDir.'save_export_configuration.gif" title="'.$this->getLibraryLL('button.saveExportConfiguration').'" alt="'.$this->getLibraryLL('button.saveExportConfiguration').'" />';				return $out;  }	/**	 * Delete export configuration	 *	 * @param $formName string (name of the form)	 *	 * @return string (Save link)	 */	public function deleteExportConfiguration($formName) {			$out = '<input type="image" class="deleteExportConfiguration" name="'.$formName.'[deleteExportConfiguration]" onclick="return confirm(\''.$this->getLibraryLL('warning.delete').'\');" src="'.$this->iconsDir.'delete_export_configuration.gif" title="'.$this->getLibraryLL('button.deleteExportConfiguration').'" alt="'.$this->getLibraryLL('button.deleteExportConfiguration').'" />';				return $out;  }	/**	 * Load export configuration	 *	 * @param $formName string (name of the form)	 *	 * @return string (Save link)	 */	public function loadExportConfiguration($formName) {			$out = '<input type="image" class="loadExportConfiguration" name="'.$formName.'[loadExportConfiguration]" src="'.$this->iconsDir.'load_export_configuration.gif" title="'.$this->getLibraryLL('button.loadExportConfiguration').'" alt="'.$this->getLibraryLL('button.loadExportConfiguration').'" />';				return $out;  }	/**	 * Toggle export configuration	 *	 * @param $formName string (name of the form)	 * @param $toggle integer (flag)	 *	 * @return string (Save link)	 */	public function toggleExportDisplay($formName, $toggle) {			$out = '<input type="image" class="toggleExportDisplay" name="'.$formName.'[toggleExportDisplay]" src="'.$this->iconsDir.'toggle_export_display.gif" title="'.$this->getLibraryLL('button.toggleExportDisplay_'.$toggle).'" alt="'.$this->getLibraryLL('button.toggleExportDisplay_'.$toggle).'" />';				return $out;  }  	/**	 * Save + Save and Close + Close buttons	 *	 * @param $formName string (name of the form)	 * @param $uid integer (uid parameter of formName)	 *	 * @return string (Save + Save and Close + Close links)	 */	  public function saveButtons($formName, $uid) {		$out = $this->saveButton($formName, $uid);		$out .= $this->saveandcloseButton($formName, $uid);		$out .= $this->closeButton($formName, $uid);		$out .= $this->hiddenField($formName . '[formAction]', '');				return $out;	}	/**	 * Hidden field	 *	 * @param $name string (name of the hidden field)	 * @param $value string (value for the field)	 *	 * @return string (hidden field)	 */		public function hiddenField($name, $value='') {			$out = '<input type="hidden" name="' . $name . '" value="' . $value . '" />';				return $out;	}	/***************************************************************/	/* JavaScript methods                                          */	/***************************************************************/	/**	 * JS Code for the delete warning	 *	 * @param $formName string (name of the form)	 *	 * @return string (Javascript code)	 */	public function generateJSWarning($formName) {			$JScode = '      <script type="text/javascript">      /*<![CDATA[*/      <!--            function updateTextareaRTE() {' . $this->itemviewers->updateRTEList . '        return true;      }      function changedTextareaRTE(x) {        if (RTEarea[x]["editor"]._undoPos>0) {          document.changed = true;                  }      }            function changePage()	{	                // Take rtehtmlarea into account        ' . $this->changedRTEList . '                if (document.changed) {          if (confirm("' . $this->getLibraryLL('warning.save') . '"))	{            document.' . $formName . '[\'' . $formName . '[formAction]\'].value="saveBtn";            ' . ($this->selectList ? $this->selectList . ';' : '') . '            updateTextareaRTE();           document.' . $formName . '.submit();            return false;          }			          return true;        }         return true;      }      // -->      /*]]>*/      </script>      ';	return $JScode;	}    /***************************************************************/  /* Condition methods                                       	   */  /***************************************************************/  	/**	 * Check if two parameters are equal	 *	 * @param $x (first parameter)	 * @param $y (second parameter)	 *	 * @return boolean (true if $x == $y)	*/    public function isEqual($x, $y) {    return ($x == $y);  }	/**	 * Check if the first parameter is in the second parameter considered as a string	 *	 * @param $x (first parameter)	 * @param $y (second parameter)	 *	 * @return boolean (true if $x is in $y)	*/    public function isInString($x, $y) {    return (!(strpos($x, $y) === false));  }	/**	 * Check if the first parameter is not in the second parameter considered as a string	 *	 * @param $x (first parameter)	 * @param $y (second parameter)	 *	 * @return boolean (true if $x is not in $y)	*/    public function isNotInString($x, $y) {    return (!(strpos($x, $y) === false));  }  	/**	 * Check if the parameter is an array	 *	 * @param $x (parameter to check)	 *	 * @return boolean (true if $x is an array)	*/      public function isArray($x) {    return (is_array($x));  }	/**	 * Check if the parameter is not an array	 *	 * @param $x (parameter to check)	 *	 * @return boolean (true if $x is not an array)	*/       public function isNotArray($x) {    return (!is_array($x));  }    /**	 * Check if a key exists in an array	 *	 * @param $x (an array)	 * @param $y (the key to check)   *	 * @return boolean (true if $y is a key in $x)	*/      public function arrayKeyExists($x, $y) {    if (is_array($x)) {      return(array_key_exists($y, $x));        }    return (false);  }	/**	 * Check if the parameter is null	 *	 * @param $x (parameter to check)	 *	 * @return boolean (true if $x is null)	*/     public function isNull($x) {    return (is_null($x));  }	/**	 * Check if the parameter is not null	 *	 * @param $x (parameter to check)	 *	 * @return boolean (true if $x is not null)	*/     	  public function isNotNull($x) {    return (!is_null($x));  }		/**	 * Check if the form is in input mode	 *	 * @return boolean (true if the input mode is active)	*/     public function isInputMode() {    return ($this->inputMode ? true : false);  }	/**	 * Check if the form is not in input mode	 *	 * @return boolean (true if the input mode is not active)	*/     public function isNotInputMode() {    return ($this->inputMode ? false : true);  }	/**	 * Check if the user is member of a group	 *	 * @return boolean (true if the current user is a member of the group)	*/     public function isGroupMember($group) {      $rows = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows(        /* SELECT   */	'uid',        /* FROM     */	'fe_groups',        /* WHERE    */	'title="' . $group . '"'  	);    return in_array($rows[0]['uid'],explode(',', $GLOBALS['TSFE']->fe_user->user['usergroup']));  }	/**	 * Check if the user is member of a group	 *	 * @return boolean (true if the current user is not a member of the group)	*/     public function isNotGroupMember($group) {    $rows = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows(        /* SELECT   */	'uid',        /* FROM     */	'fe_groups',        /* WHERE    */	'title="' . $group . '"'  	);    return !in_array($rows[0]['uid'],explode(',', $GLOBALS['TSFE']->fe_user->user['usergroup']));  }  /***************************************************************/  /* Make methods                                       	       */  /***************************************************************/	/**	 * Generate the xml label 	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (xml label)	 */  public function makeXmlLabel ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];		return $GLOBALS['TSFE']->sL($params['xmllabel' . $special] . $value);	}   	/**	 * Create an image	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (image)	 */	public function makeImage ($value, $uid='', $params=array()) {		if (!$value) return('');	  $special = $params['funcspecial'];		$folder = $params['folder' . $special] ? $params['folder' . $special] : '.';		$width = $params['width' . $special] ? ' width="' . $params['width' . $special] . '"' : '';		$height = $params['height' . $special] ? ' height="' . $params['height' . $special] . '"' : '';		return '<img src="' . $folder . '/' . $value . '"' . $width . $height . ' alt="' . $params['alt' . $special] . '" />';	}	/**	 * Create an item link	 *	 * @param $value string (value to display)	 * @param $uid string (uid parameter of formName)	 * @param $params array (parameters)	 *	 * @return string (link)	 */	public function makeItemLink ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];    $linkParams = array(      'sav_library' => 1,      $this->formName . '[formAction]' => ($params['updateform' . $special] ? 'updateForm' : ($params['inputform' . $special] ? 'inputForm' : 'showSingle')),      $this->formName . '[uid]' => $uid,    );    if ($params['page' . $special]) {      $linkParams[$this->formName . '[page]'] = $params['page' . $special];    }    return $this->extObj->pi_linkTP($value, $linkParams, 1);	}	/**	 * Create an extension link	 *	 * @param $value string (value to display)	 * @param $uid string (uid parameter of formName)	 * @param $params array (parameters)	 *	 * @return string (link)	 */		public function makeExtLink ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];    $formName = $params['ext' . $special] . ($params['contentid' . $special] ? '_' . $params['contentid' . $special] : '');    $linkParams = array(      $formName.'[formAction]' => 'showSingle',      $formName.'[uid]' => ($this->rowItem ? $params['_value'] : $uid),    );    if ($params['page' . $special]) {      $linkParams[$this->formName . '[page]'] = $params['page' . $special];    }        // Check if the link should be displayed	    if ($params['restrictlinkto'].$special) {      if (preg_match('/###usergroup[ ]*(!?)=[ ]*(.*?)###/', $params['restrictlinkto' . $special], $match)) {        $rows = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows(				    /* SELECT   */	'uid,title',					    /* FROM     */	'fe_groups',	 			    /* WHERE    */	'title=\'' . $match[2] . '\'' . $this->extObj->cObj->enableFields('fe_groups')		    );        $cond = (bool)$match[1] ^ in_array($rows[0]['uid'], explode(',',$GLOBALS['TSFE']->fe_user->user['usergroup'])); 	        return ($cond ?  $this->extObj->pi_linkToPage($value, $params['pageid' . $special], '', $linkParams) : $value);      } else {        return $this->extObj->pi_linkToPage($value, $params['pageid' . $special], '', $linkParams);      }    } else {      return $this->extObj->pi_linkToPage($value, $params['pageid' . $special], '', $linkParams);    }	}	/**	 * Create an email link	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (link)	 */	public function makeEmailLink ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];    $message = $params['message' . $special] ? $params['message' . $special] : $value;		$TSconf = array(      'parameter'  => ($params['link' . $special] ? $params['link' . $special] : $value),    );      	return $this->extObj->cObj->typolink($message, $TSconf);	}	/**	 * Create a link and open in a new window	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (link)	 */	public function makeNewWindowLink ($value, $uid='', $params='') {	  $special = $params['funcspecial'];    $message = $params['message' . $special] ? $params['message' . $special] : $value;    $params['windowurl' . $special] = preg_replace('/###special\[([^\]]*)\]###/e', '$params[\'special\'][\'$1\']', $params['windowurl' . $special]);    $params['windowtext' . $special] = preg_replace('/###special\[([^\]]*)\]###/e', '$params[\'special\'][\'$1\']', $params['windowtext' . $special]);    $windowBodyStyle = ($params['windowbodystyle' . $special] ? ' style="' . $params['windowbodystyle' . $special] . '"' : '');		$TSconf = array(		  'bodyTag' => '<body' . $windowBodyStyle . '>' . ($params['windowtext' . $special] ? $params['windowtext' . $special] . '<br />': ''),      'enable'  => 1,      'JSwindow'  => 1,      'wrap' => '<a href="javascript:close();"> | </a>',      'JSwindow.' => array(          'newWindow'  => 1,          'expand' => '20,' . ($params['windowtext' . $special] ? '40' : '20'),      ),        );    return $this->extObj->cObj->imageLinkWrap($message, $params['windowurl'.$special], $TSconf);	}	/**	 * Create an internal link	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (link)	 */		public function makeLink ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];		$folder = $params['folder' . $special] ? $params['folder' . $special] : '.';    $message = $params['message' . $special] ? $params['message' . $special] : $value;		$TSconf = array(      'parameter'  => ($value ? ($params['setuid' . $special] ? $params['setuid' . $special] : ($params['valueisuid' . $special] ? $params['_value'] : $folder . '/' . $value)) : ''),      'target'  => $params['target' . $special],      'ATagParams' => $params['class' . $special] ? 'class="' . $params['class' . $special] . '" ' :  '',    );      	return $this->extObj->cObj->typolink($message, $TSconf);	}		/**	 * Create a link for an external url	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (link)	 */		public function makeUrlLink ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];    $message = $params['message' . $special] ? $params['message' . $special] : $value;		$TSconf = array(      'parameter'  => ($params['link' . $special] ? $params['link' . $special] : $params['_value']),      'extTarget'  => '_blank',    );      	return $this->extObj->cObj->typolink($message, $TSconf);	}	/**	 * Create a date in a given format	 *	 * @param $value string (value to display)	 * @param $uid string (not used)	 * @param $params array (parameters)	 *	 * @return string (formated date)	 */		public function makeDateFormat ($value, $uid='', $params=array()) {	  $special = $params['funcspecial'];	  $format = ($params['format'.$special] ? $params['format'.$special] : ($params['eval' . $special]=='datetime' ? '%d/%m/%Y %H:%M' : '%d/%m/%Y'));		return strftime($format, $value);	}  /***************************************************************  * Database methods                                          ***************************************************************/	/**	 * Query for deleting.	 *	 */	public function queries_delete(&$query) {    $func = trim($this->savlibraryConfig['queriers']['delete']);		$this->queriers->$func($query, $this->uid);	}	/**	 * Query for updating.	 *	 */	public function queries_update(&$query) {    $func = trim($this->savlibraryConfig['queriers']['update']);		return $this->queriers->$func($query, $this->uid);	}	/**	 * Check if it is a SELECT query	 *	 */	public function isSelectQuery($query) {    return preg_match('/^[ \r\t\n]*(?i)select[ ]*/',$query);  }  	/***************************************************************/	/* comfortable template methods                                */	/* The following code was developped from the VCD Library      */  /* @author	Elmar Hinz <elmar.hinz@vcd-berlin.de>              */ 	/***************************************************************/	public function replaceTemplate($array, $tpl="") { 		if(empty($tpl)) {			if(in_array('TYPE', array_map('strtoupper', array_keys($array)))) {				$out = $this->_doTemplateItem($array, $this->templateCode); 			} else {				$out = '<p>Unecpected call of function replaceTemplate.</p>';			} 		} else {			$out = $this->_doTemplate($array, $tpl);		}				return $out;	}	public function _doTemplate($inReps, $tpl) {		global $elmar;		if(is_array($inReps)) {			foreach($inReps as $k => $v) {				$reps[strtolower($k)] = $v;			}			$tpl = $this->_doTemplateRegions($reps[regions], $tpl);			$tpl = $this->_doTemplateMarkers($reps[markers], $tpl);			$tpl = $this->_doTemplateCutters($reps[cutters], $tpl); 		}		return $tpl;	}	public function _doTemplateRegions($containers, $tpl) {		$markers = array();		if(is_array($containers)) {			foreach($containers as $container => $items) {				$itemsTpl = $this->extObj->cObj->getSubpart($tpl, '###'.$container.'###');				$markers[$container] = $this->_doTemplateItems($items, $itemsTpl);			}		}		$MARKERS = array();		if(is_array($markers)) {			foreach($markers as $k => $v) $MARKERS['###'.$k.'###'] = $v;		}		$out = $this->extObj->cObj->substituteMarkerArrayCached($tpl, array(), $MARKERS, array());		return $out;	}	public function _doTemplateItems($items, $itemsTpl) {		if(is_array($items)) {			foreach($items as $counter => $components) {				$out .= $this->_doTemplateItem($components, $itemsTpl);			}		} else {			$out = $tpl;    }		return $out;	}	public function _doTemplateItem($components, $itemsTpl) {		if(is_array($components)) {			foreach($components as $k => $v) {				$comps[strtolower($k)] = $v;			}			$itemTpl = $this->extObj->cObj->getSubpart($itemsTpl, '###'.$comps['type'].'###');		}		$out = $this->_doTemplate($comps, $itemTpl);		if ($components['WRAPPERS']['wrapitem']) {		  $out = $this->extObj->cObj->dataWrap($out, $components['WRAPPERS']['wrapitem']);    }		return $out;	}	public function _doTemplateMarkers($markers, $tpl) {		$MARKERS = array();		if(is_array($markers)) {			foreach($markers as $k => $v) $MARKERS['###'.$k.'###'] = $v;		}		$out = $this->extObj->cObj->substituteMarkerArrayCached($tpl, $MARKERS, array(),array());		return $out;	}	public function _doTemplateCutters($cuts, $tpl) {		$clips = array();		if(is_array($cuts)) {			foreach($cuts as $k => $v) {				$k = '###'.$k.'###';				$clips[$k] = $v ? '' : $this->extObj->cObj->getSubpart($tpl, $k);			}		}		$out = $this->extObj->cObj->substituteMarkerArrayCached($tpl, array(), $clips, array());		return $out;	}		/***************************************************************/	/* Recursive encoding and decoding                             */	/***************************************************************/	/* htmlspecialchars recursiv */	protected function hscRecurs( $in ) {		if(is_array($in)) {			foreach($in as $k => $v) {				$out[$k] = $this->hscRecurs($v);			}		} else {				$out = htmlspecialchars($in, ENT_QUOTES);		}		return $out;	}	/* addslashes recursiv */	protected function addslRecurs( $in ) {		if(is_array($in)) {			foreach($in as $k => $v) {				$out[$k] = $this->addslRecurs($v);			}		} else {			$out = addslashes($in);		}		return $out;	}	/* stripslashes recursiv */	protected function strslRecurs( $in ) {		if(is_array($in)) {			foreach($in as $k => $v) {				$out[$k] = $this->strslRecurs($v);			}		} else {			 $out = stripslashes($in);		}	return $out;	}}if (defined('TYPO3_MODE') && $TYPO3_CONF_VARS[TYPO3_MODE]['XCLASS']['ext/sav_library/class.tx_savlibrary.php']) {    include_once($TYPO3_CONF_VARS[TYPO3_MODE]['XCLASS']['ext/sav_library/class.tx_savlibrary.php']);}?>